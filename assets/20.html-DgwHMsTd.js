import{_ as E}from"./gzh-DnOBNg6W.js";import{_ as F}from"./zsxq-BcdwOI-_.js";import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as t,c as y,b as p,w as n,a as e,o as C,e as l,d as s}from"./app-DguKnX9N.js";const D="/assets/e04a4e460bd42f7732d1c56b1fc165cd-DoE9Mena.jpg",d="/assets/pixel-jeff-homecoming-mQf9QlC7.gif",u="/assets/image-20230130101101621-D1E6o7VC.png",v="/assets/image-20230130101219537-rGyzvuLq.png",m={},b=e('<figure><img src="'+D+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="'+d+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>你好，我是悦创。</p><p>上一节课的最后，我们留下一个小小的悬念：生成器在 Python 2 中还扮演了一个重要角色，就是用来实现 Python 协程。</p><p>那么首先你要明白，什么是协程？</p><p>协程是实现并发编程的一种方式。一说并发，你肯定想到了多线程 / 多进程模型，没错，多线程 / 多进程，正是解决并发问题的经典模型之一。最初的互联网世界，多线程 / 多进程在服务器并发中，起到举足轻重的作用。</p><p>随着互联网的快速发展，你逐渐遇到了 C10K 瓶颈，也就是同时连接到服务器的客户达到了一万个。于是很多代码跑崩了，进程上下文切换占用了大量的资源，线程也顶不住如此巨大的压力，这时， NGINX 带着事件循环出来拯救世界了。</p><p>如果将多进程 / 多线程类比为起源于唐朝的藩镇割据，那么事件循环，就是宋朝加强的中央集权制。事件循环启动一个统一的调度器，让调度器来决定一个时刻去运行哪个任务，于是省却了多线程中启动线程、管理线程、同步锁等各种开销。同一时期的 NGINX，在高并发下能保持低资源低消耗高性能，相比 Apache 也支持更多的并发连接。</p><p>再到后来，出现了一个很有名的名词，叫做回调地狱（callback hell），手撸过 JavaScript 的朋友肯定知道我在说什么。我们大家惊喜地发现，这种工具完美地继承了事件循环的优越性，同时还能提供 async / await 语法糖，解决了执行性和可读性共存的难题。于是，协程逐渐被更多人发现并看好，也有越来越多的人尝试用 Node.js 做起了后端开发。（讲个笑话，JavaScript 是一门编程语言。）</p><p>回到我们的 Python。使用生成器，是 Python 2 开头的时代实现协程的老方法了，Python 3.7 提供了新的基于 asyncio 和 async / await 的方法。我们这节课，同样的，跟随时代，抛弃掉不容易理解、也不容易写的旧的基于生成器的方法，直接来讲新方法。</p><p>我们先从一个爬虫实例出发，用清晰的讲解思路，带你结合实战来搞懂这个不算特别容易理解的概念。之后，我们再由浅入深，直击协程的核心。</p><h2 id="_1-从一个爬虫说起" tabindex="-1"><a class="header-anchor" href="#_1-从一个爬虫说起"><span>1. 从一个爬虫说起</span></a></h2><p>爬虫，就是互联网的蜘蛛，在搜索引擎诞生之时，与其一同来到世上。爬虫每秒钟都会爬取大量的网页，提取关键信息后存储在数据库中，以便日后分析。爬虫有非常简单的 Python 十行代码实现，也有 Google 那样的全球分布式爬虫的上百万行代码，分布在内部上万台服务器上，对全世界的信息进行嗅探。</p><p>话不多说，我们先看一个简单的爬虫例子：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">def</span><span style="color:#88C0D0;"> crawl_page</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">crawling </span><span style="color:#EBCB8B;">{}</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">format</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    sleep_time </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> int</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">split</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">_</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)[</span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">])</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    time</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">sleep_time</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">OK </span><span style="color:#EBCB8B;">{}</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">format</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">urls</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#D8DEE9FF;"> url </span><span style="color:#81A1C1;">in</span><span style="color:#D8DEE9FF;"> urls</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#88C0D0;">        crawl_page</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;">time </span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">([</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">url_1</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">url_2</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">url_3</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">url_4</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">########## 输出 ##########</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_4</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_4</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Wall time</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;"> s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（注意：本节的主要目的是协程的基础概念，因此我们简化爬虫的 scrawl_page 函数为休眠数秒，休眠时间取决于 url 最后的那个数字。）</p><p>这是一个很简单的爬虫，<code>main()</code> 函数执行时，调取 <code>crawl_page()</code> 函数进行网络通信，经过若干秒等待后收到结果，然后执行下一个。</p><p>看起来很简单，但你仔细一算，它也占用了不少时间，五个页面分别用了 1 秒到 4 秒的时间，加起来一共用了 10 秒。这显然效率低下，该怎么优化呢？</p><p>于是，一个很简单的思路出现了——我们这种爬取操作，完全可以并发化。我们就来看看使用协程怎么写。</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> crawl_page</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">crawling </span><span style="color:#EBCB8B;">{}</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">format</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    sleep_time </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> int</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">split</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">_</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)[</span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">])</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">sleep_time</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">OK </span><span style="color:#EBCB8B;">{}</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">format</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">urls</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#D8DEE9FF;"> url </span><span style="color:#81A1C1;">in</span><span style="color:#D8DEE9FF;"> urls</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#81A1C1;">        await</span><span style="color:#88C0D0;"> crawl_page</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;">time asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">([</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">url_1</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">url_2</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">url_3</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">url_4</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">########## 输出 ##########</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">crawling url_4</span></span>
<span class="line"><span style="color:#D8DEE9FF;">OK url_4</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Wall time</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;"> s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看到这段代码，你应该发现了，在 Python 3.7 以上版本中，使用协程写异步程序非常简单。</p><p>首先来看 import asyncio，这个库包含了大部分我们实现协程所需的魔法工具。</p><p>async 修饰词声明异步函数，于是，这里的 crawl_page 和 main 都变成了异步函数。而调用异步函数，我们便可得到一个协程对象（coroutine object）。</p><p>举个例子，如果你 <code>print(crawl_page(&#39;&#39;))</code>，便会输出，提示你这是一个 Python 的协程对象，而并不会真正执行这个函数。</p><p>再来说说协程的执行。执行协程有多种方法，这里我介绍一下常用的三种。</p><p>首先，我们可以通过 await 来调用。await 执行的效果，和 Python 正常执行是一样的，也就是说程序会阻塞在这里，进入被调用的协程函数，执行完毕返回后再继续，而这也是 await 的字面意思。代码中 <code>await asyncio.sleep(sleep_time)</code> 会在这里休息若干秒，<code>await crawl_page(url) </code>则会执行 <code>crawl_page()</code> 函数。</p><p>其次，我们可以通过 <code>asyncio.create_task()</code> 来创建任务，这个我们下节课会详细讲一下，你先简单知道即可。</p><p>最后，我们需要 <code>asyncio.run</code> 来触发运行。<code>asyncio.run</code> 这个函数是 Python 3.7 之后才有的特性，可以让 Python 的协程接口变得非常简单，你不用去理会事件循环怎么定义和怎么使用的问题（我们会在下面讲）。一个非常好的编程规范是，<code>asyncio.run(main())</code> 作为主程序的入口函数，在程序运行周期内，只调用一次 <code>asyncio.run</code>。</p><p>这样，你就大概看懂了协程是怎么用的吧。不妨试着跑一下代码，欸，怎么还是 10 秒？</p><p>10 秒就对了，还记得上面所说的，await 是同步调用，因此， <code>crawl_page(url)</code> 在当前的调用结束之前，是不会触发下一次调用的。于是，这个代码效果就和上面完全一样了，相当于我们用异步接口写了个同步代码。</p><p>现在又该怎么办呢？</p><p>其实很简单，也正是我接下来要讲的协程中的一个重要概念，任务（Task）。老规矩，先看代码。</p>`,32),A=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," tasks"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"        await"),s("span",{style:{color:"#D8DEE9FF"}}," task")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"%"),s("span",{style:{color:"#D8DEE9FF"}},"time asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"########## 输出 ##########")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Wall time"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 3.99"),s("span",{style:{color:"#D8DEE9FF"}}," s")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),h=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," time")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # time.sleep(sleep_time)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," tasks"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"        await"),s("span",{style:{color:"#D8DEE9FF"}}," task")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # for url in urls:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    #     await crawl_page(url)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"# %time asyncio.run(main(['url_1', 'url_2', 'url_3', 'url_4']))")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#D8DEE9FF"}},"start_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#81A1C1"}},"await"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#88C0D0"}},"print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," -"),s("span",{style:{color:"#D8DEE9FF"}}," start_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"########## 输出 ##########")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B48EAD"}},"4.005578994750977")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),_=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," time")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # time.sleep(sleep_time)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," tasks"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"        await"),s("span",{style:{color:"#D8DEE9FF"}}," task")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # for url in urls:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    #     await crawl_page(url)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"# %time asyncio.run(main(['url_1', 'url_2', 'url_3', 'url_4']))")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#D8DEE9FF"}},"start_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#88C0D0"}},"print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," -"),s("span",{style:{color:"#D8DEE9FF"}}," start_time"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),g=e('<p>你可以看到，我们有了协程对象后，便可以通过 <code>asyncio.create_task</code> 来创建任务。任务创建后很快就会被调度执行，这样，我们的代码也不会阻塞在任务这里。所以，我们要等所有任务都结束才行，用 <code>for task in tasks: await task</code> 即可。</p><p>这次，你就看到效果了吧，<strong>结果显示，运行总时长等于运行时间最长的爬虫。</strong></p><div class="hint-container info"><p class="hint-container-title">探究协程原因</p><p><strong>举个例子🌰：</strong></p><p>目标：小 Cava 要做一道美味的鱼汤。</p><p><strong>正常的流程：</strong></p><ol><li>🐟杀鱼「3min」</li><li>🫀清洗内脏「2min」</li><li>🍳锅热入凉油「2min」</li><li>🎏加入备好的：生姜、大葱「3min」</li><li>🔆煎至：两面金黄「5min」</li><li>🎃加入凉水煮，等到煮开「15min」</li><li>开吃～</li><li>PS：煮开水：15min</li><li>⌚️Total Time：30 min</li></ol><blockquote><p>忽略细节部分，主要理解协程真谛。</p></blockquote><p><strong>更好的流程：</strong></p><ol><li>🎃煮开水：15min <ol><li>🐟杀鱼「3min」</li><li>🫀清洗内脏「2min」</li><li>🍳锅热入凉油「2min」</li><li>🎏加入备好的：生姜、大葱「3min」</li><li>🔆煎至：两面金黄「5min」</li></ol></li><li>🐟鱼加入煮开的开水，再煮 2min，直接出锅～「鱼不是程序，还是得煮出鱼汤的，而计算机就不用。」</li><li>开吃～</li><li>⌚️Total Time：17min「要是计算机的话，不需要添加煮鱼的 2min」</li></ol><hr><p>煮开水被第二种方法，类似：挂起。那挂起就没有在煮开水吗？——No，还是在继续煮开水，不会因为你挂起而停止煮开水。</p><p>那协程是什么意思？就是把耗时的、请求慢的、下载慢的，挂起继续后台下载，在下载的时候呢，去请求其他的链接🔗。</p></div><p>当然，你也可以想一想，这里用多线程应该怎么写？而如果需要爬取的页面有上万个又该怎么办呢？再对比下协程的写法，谁更清晰自是一目了然。</p><p>其实，对于执行 tasks，还有另一种做法：</p>',5),B=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"*"),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"%"),s("span",{style:{color:"#D8DEE9FF"}},"time asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"########## 输出 ##########")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"OK url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Wall time"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 4.01"),s("span",{style:{color:"#D8DEE9FF"}}," s")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),f=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," time")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"*"),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"start_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," -"),s("span",{style:{color:"#D8DEE9FF"}}," start_time"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),k=e(`<p>这里的代码也很好理解。唯一要注意的是，<code>*tasks</code> 解包列表，将列表变成了函数的参数；与之对应的是， <code>** dict</code> 将字典变成了函数的参数。</p><p>另外，<code>asyncio.create_task</code>，<code>asyncio.run</code> 这些函数都是 Python 3.7 以上的版本才提供的，自然，相比于旧接口它们也更容易理解和阅读。</p><h2 id="_2-补充" tabindex="-1"><a class="header-anchor" href="#_2-补充"><span>2. 补充</span></a></h2><h3 id="_2-1-asyncio-gather-vs-asyncio-wait" tabindex="-1"><a class="header-anchor" href="#_2-1-asyncio-gather-vs-asyncio-wait"><span>2.1 asyncio.gather vs asyncio.wait</span></a></h3><p>在上面的内容，我们知道有：<code>asyncio.gather</code> 与 <code>asyncio.wait</code>，他们都可以让多个协程并发执行。那为什么提供 2 个方法呢？它们有什么区别，适用场景是怎么样的呢？其实我之前也是有点困惑，直到我读了 asyncio 的源码。我们先看 2 个协程的例子:</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> a</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Suspending a</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Resuming a</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">A</span><span style="color:#ECEFF4;">&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> b</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Suspending b</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Resuming b</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">B</span><span style="color:#ECEFF4;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 IPython 里面用 gather 执行一下：</p>`,7),w=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"2"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," return_value_a"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," return_value_b "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"())")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Suspending a")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Suspending b")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Resuming b")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Resuming a")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"3"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," return_value_a"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," return_value_b")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"3"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#ECEFF4"}}," ("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"A"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),x=s("p",null,[l("Ok，"),s("code",null,"asyncio.gather"),l(" 方法的名字说明了它的用途，gather 的意思是「搜集」，也就是能够收集协程的结果，而且要注意，它会按输入协程的顺序保存的对应协程的执行结果。")],-1),T=s("p",null,[l("接着我们说 "),s("code",null,"asyncio.await"),l(" ，先执行一下：")],-1),O=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"4"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," pending "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"4"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9FF"}},"c7c81c0fc688"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#8FBCBB"}}," DeprecationWarning"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}}," The explicit passing of coroutine objects to asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," is"),s("span",{style:{color:"#D8DEE9FF"}}," deprecated since Python "),s("span",{style:{color:"#B48EAD"}},"3.8"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#81A1C1"}}," and"),s("span",{style:{color:"#D8DEE9FF"}}," scheduled "),s("span",{style:{color:"#81A1C1"}},"for"),s("span",{style:{color:"#D8DEE9FF"}}," removal "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," Python "),s("span",{style:{color:"#B48EAD"}},"3.11"),s("span",{style:{color:"#ECEFF4"}},".")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"  done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," pending "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Suspending a")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Suspending b")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Resuming b")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Resuming a")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"5"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," done")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"5"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},"{"),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"Task finished name="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Task-526"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#D8DEE9FF"}}," coro="),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#D8DEE9FF"}}," done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," defined at "),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9FF"}},"ad0e9324f79a"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"4"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#D8DEE9FF"}}," result="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"A"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}}," <"),s("span",{style:{color:"#D8DEE9FF"}},"Task finished name="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Task-527"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#D8DEE9FF"}}," coro="),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#88C0D0"}},"b"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#D8DEE9FF"}}," done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," defined at "),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9FF"}},"ad0e9324f79a"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"11"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#D8DEE9FF"}}," result="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"6"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," pending")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"6"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#88C0D0"}}," set"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"7"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," list"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"done"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#B48EAD"}},"0"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"8"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," task")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"8"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#81A1C1"}}," <"),s("span",{style:{color:"#D8DEE9FF"}},"Task finished name"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Task-527"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#D8DEE9FF"}}," coro"),s("span",{style:{color:"#81A1C1"}},"=<"),s("span",{style:{color:"#88C0D0"}},"b"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#D8DEE9FF"}}," done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," defined at "),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9FF"}},"ad0e9324f79a"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"11"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#D8DEE9FF"}}," result"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#81A1C1"}},">")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"9"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"result")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"9"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#81A1C1"}}," <"),s("span",{style:{color:"#D8DEE9FF"}},"function Task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"result"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}},">")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"10"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"result"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"10"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),P=s("p",null,[s("code",null,"asyncio.wait"),l(" 的返回值有 2 项，第一项表示完成的任务列表 (done)，第二项表示等待 (Future) 完成的任务列表 (pending)，每个任务都是一个 Task 实例，由于这 2 个任务都已经完成，所以可以执行 "),s("code",null,"task.result()"),l(" 获得协程返回值。")],-1),I=s("p",null,"Ok, 说到这里，我总结下它俩的区别的第一层区别：",-1),S=s("ol",null,[s("li",null,[s("code",null,"asyncio.gather"),l(" 封装的 Task 全程黑盒，只告诉你协程结果。")]),s("li",null,[s("code",null,"asyncio.wait"),l(" 会返回封装的 Task (包含已完成和挂起的任务)，如果你关注协程执行结果你需要从对应 Task 实例里面用 result 方法自己拿。")])],-1),K=s("p",null,[l("为什么说「第一层区别」，"),s("code",null,"asyncio.wait"),l(" 看名字可以理解为「等待」，所以返回值的第二项是 pending 集合，但是看上面的例子，pending 是空集合，那么在什么情况下，pending 里面不为空呢？这就是第二层区别："),s("code",null,"asyncio.wait"),l(" 支持选择返回的时机。")],-1),q=s("p",null,[s("code",null,"asyncio.wait"),l(" 支持一个接收参数 "),s("code",null,"return_when"),l("，在默认情况下，"),s("code",null,"asyncio.wait"),l(" 会等待全部任务完成 "),s("code",null,"(return_when='ALL_COMPLETED')"),l("，它还支持 "),s("code",null,"FIRST_COMPLETED"),l("（第一个协程完成就返回）和 "),s("code",null,"FIRST_EXCEPTION"),l("（出现第一个异常就返回）：")],-1),R=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"11"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," pending "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()],"),s("span",{style:{color:"#D8DEE9"}}," return_when"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"FIRST_COMPLETED"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"11"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9"}},"36382977e01c"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#8FBCBB"}}," DeprecationWarning"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}}," The explicit passing of coroutine objects to asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," is"),s("span",{style:{color:"#D8DEE9FF"}}," deprecated since Python "),s("span",{style:{color:"#B48EAD"}},"3.8"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#81A1C1"}}," and"),s("span",{style:{color:"#D8DEE9FF"}}," scheduled "),s("span",{style:{color:"#81A1C1"}},"for"),s("span",{style:{color:"#D8DEE9FF"}}," removal "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," Python "),s("span",{style:{color:"#B48EAD"}},"3.11"),s("span",{style:{color:"#ECEFF4"}},".")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"  done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," pending "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()],"),s("span",{style:{color:"#D8DEE9"}}," return_when"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"FIRST_COMPLETED"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Suspending a")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Suspending b")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Resuming b")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"12"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," done")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"12"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#ECEFF4"}}," {"),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"Task finished name="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Task-1094"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#D8DEE9FF"}}," coro="),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#88C0D0"}},"b"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#D8DEE9FF"}}," done"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," defined at "),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9FF"}},"ad0e9324f79a"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"11"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#D8DEE9FF"}}," result="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"13"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#D8DEE9FF"}}," pending")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"13"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#ECEFF4"}}," {"),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"Task pending name="),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Task-1093"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#D8DEE9FF"}}," coro="),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#D8DEE9FF"}}," running at "),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"ipython"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#88C0D0"}},"input"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#D8DEE9FF"}},"ad0e9324f79a"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}},"6"),s("span",{style:{color:"#81A1C1"}},">"),s("span",{style:{color:"#D8DEE9FF"}}," wait_for="),s("span",{style:{color:"#81A1C1"}},"<"),s("span",{style:{color:"#D8DEE9FF"}},"Future pending cb="),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#D8DEE9FF"}},"Task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"task_wakeup"),s("span",{style:{color:"#ECEFF4"}},"()]"),s("span",{style:{color:"#81A1C1"}},">>"),s("span",{style:{color:"#ECEFF4"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"In "),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"14"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#88C0D0"}}," type"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"done"),s("span",{style:{color:"#ECEFF4"}},"),"),s("span",{style:{color:"#88C0D0"}}," type"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"pending"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Out"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"14"),s("span",{style:{color:"#ECEFF4"}},"]:"),s("span",{style:{color:"#ECEFF4"}}," ("),s("span",{style:{color:"#88C0D0"}},"set"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#88C0D0"}}," set"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),j=s("p",null,"看到了吧，这次只有协程 b 完成了，协程 a 还是 pending 状态。",-1),L=s("p",null,[l("在大部分情况下，用 "),s("code",null,"asyncio.gather"),l(" 是足够的，如果你有特殊需求，可以选择 "),s("code",null,"asyncio.wait"),l("，举 2 个例子：")],-1),N=s("ol",null,[s("li",null,"需要拿到封装好的 Task，以便取消或者添加成功回调等"),s("li",null,[l("业务上需要 "),s("code",null,"FIRST_COMPLETED/FIRST_EXCEPTION"),l(" 即返回的")])],-1),W=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," a"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Suspending a"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#B48EAD"}},"3"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Resuming a"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"A"),s("span",{style:{color:"#ECEFF4"}},"'")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Suspending b"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Resuming b"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"renwu "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"loops "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"get_event_loop"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"return_value_a"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," return_value_b "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," loops"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run_until_complete"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"renwu"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"# return_value_a, return_value_b = loops.run_until_complete(asyncio.gather(*renwu))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"# return_value_a, return_value_b = loops.run_until_complete(asyncio.gather(a(), b()))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"return_value_a"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," return_value_b"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),M=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," a"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Suspending a"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#B48EAD"}},"3"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Resuming a"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"A"),s("span",{style:{color:"#ECEFF4"}},"'")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Suspending b"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"Resuming b"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"B"),s("span",{style:{color:"#ECEFF4"}},"'")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," c1"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," c2"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()]))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," c3"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"wait"),s("span",{style:{color:"#ECEFF4"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},"        ["),s("span",{style:{color:"#88C0D0"}},"a"),s("span",{style:{color:"#ECEFF4"}},"(),"),s("span",{style:{color:"#88C0D0"}}," b"),s("span",{style:{color:"#ECEFF4"}},"()],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9"}},"        return_when"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"FIRST_COMPLETED"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"if"),s("span",{style:{color:"#D8DEE9FF"}}," __name__ "),s("span",{style:{color:"#81A1C1"}},"=="),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"__main__"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," f "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#ECEFF4"}}," ("),s("span",{style:{color:"#D8DEE9FF"}},"c1"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," c2"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," c3"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"f"),s("span",{style:{color:"#ECEFF4"}},"())")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),z=e(`<h3 id="_2-2-asyncio-create-task-vs-loop-create-task-vs-asyncio-ensure-future" tabindex="-1"><a class="header-anchor" href="#_2-2-asyncio-create-task-vs-loop-create-task-vs-asyncio-ensure-future"><span>2.2 asyncio.create_task vs loop.create_task vs asyncio.ensure_future</span></a></h3><p>创建一个 Task 一共有 3 种方法，如这小节的标题。从 Python 3.7 开始可以统一的使用更高阶的 <code>asyncio.create_task</code> 。其实<code>asyncio.create_task</code> 就是用的 <code>loop.create_task</code> ：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">from</span><span style="color:#D8DEE9FF;"> asyncio </span><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> events</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">def</span><span style="color:#88C0D0;"> create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">coro</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    loop </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> events</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get_running_loop</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9FF;"> loop</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">coro</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>loop.create_task</code> 接受的参数需要是一个协程，但是 <code>asyncio.ensure_future</code> 除了接受协程，还可以是 Future 对象或者 awaitable 对象:</p><ol><li>如果参数是协程，其实底层还是用的 <code>loop.create_task</code>，返回 Task 对象</li><li>如果是 Future 对象会直接返回</li><li>如果是一个 awaitable 对象会 await 这个对象的 <code>__await__</code> 方法，再执行一次 <code>ensure_future</code>，最后返回 Task 或者 Future</li></ol><p>所以就像 <code>ensure_future</code> 名字说的，确保这个是一个 Future 对象：Task 是 Future 子类，前面说过一般情况下开发者不需要自己创建 Future</p><p>其实前面说的 <code>asyncio.wait</code> 和 <code>asyncio.gather</code> 里面都用了 <code>asyncio.ensure_future</code> 。对于绝大多数场景要并发执行的是协程，所以直接用 <code>asyncio.create_task</code> 就足够了~</p><h3 id="_2-3-shield" tabindex="-1"><a class="header-anchor" href="#_2-3-shield"><span>2.3 shield</span></a></h3><p>接着说 <code>asyncio.shield</code>，用它可以屏蔽取消操作。一直到这里，我们还没有见识过 Task 的取消。看一个例子:</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> loop </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get_event_loop</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> task1 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> loop</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">a</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> task2 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> loop</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">b</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> task1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cancel</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Out</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gather</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">task1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> task2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Suspending a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Suspending b</span></span>
<span class="line"><span style="color:#D8DEE9;">--------------------------------------------------------------------------</span><span style="color:#81A1C1;">-</span></span>
<span class="line"><span style="color:#D8DEE9FF;">CancelledError                            </span><span style="color:#88C0D0;">Traceback</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">most recent call last</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">cell_name </span><span style="color:#81A1C1;">in</span><span style="color:#81A1C1;"> async-def-</span><span style="color:#88C0D0;">wrapper</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">CancelledError</span><span style="color:#ECEFF4;">:</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的例子中，task1 被取消了后再用 <code>asyncio.gather</code> 收集结果，直接抛 CancelledError 错误了。这里有个细节，gather 支持 <code>return_exceptions</code> 参数：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gather</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">task1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> task2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> return_exceptions</span><span style="color:#81A1C1;">=True</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Out</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9FF;">concurrent</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">futures</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">_base</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CancelledError</span><span style="color:#ECEFF4;">(),</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">B</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，task2 依然会执行完成，但是 task1 的返回值是一个 CancelledError 错误，也就是任务被取消了。如果一个创建后就不希望被任何情况取消，可以使用 <code>asyncio.shield</code> 保护任务能顺利完成：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> task1 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">shield</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">a</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> task2 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> loop</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">b</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> ts </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gather</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">task1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> task2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> return_exceptions</span><span style="color:#81A1C1;">=True</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> task1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cancel</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Out</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> ts</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Suspending a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Suspending b</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Resuming a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Resuming b</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Out</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9FF;">concurrent</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">futures</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">_base</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CancelledError</span><span style="color:#ECEFF4;">(),</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">B</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到虽然结果是一个 CancelledError 错误，但是看输出能确认协程实际上是执行了的。</p><div class="hint-container info"><p class="hint-container-title">注</p><p>此处之前有一个理解错误，已经在 <a href="#">深入 asyncio.shield</a> 中重新解释和理解，推荐阅读。</p></div><h3 id="_2-4-asynccontextmanager" tabindex="-1"><a class="header-anchor" href="#_2-4-asynccontextmanager"><span>2.4 asynccontextmanager</span></a></h3><p>如果你了解 Python，之前可能听过或者用过 contextmanager ，一个上下文管理器。通过一个计时的例子就理解它的作用:</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">from</span><span style="color:#D8DEE9FF;"> contextlib </span><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> contextmanager</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> a</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">A</span><span style="color:#ECEFF4;">&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> b</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">B</span><span style="color:#ECEFF4;">&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> s1</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gather</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">a</span><span style="color:#ECEFF4;">(),</span><span style="color:#88C0D0;"> b</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">contextmanager</span></span>
<span class="line"><span style="color:#81A1C1;">def</span><span style="color:#88C0D0;"> timed</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">func</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    start </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> time</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">perf_counter</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">    yield</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">func</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">f</span><span style="color:#A3BE8C;">&#39;Cost: </span><span style="color:#EBCB8B;">{</span><span style="color:#D8DEE9FF;">time</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">perf_counter</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> -</span><span style="color:#D8DEE9FF;"> start</span><span style="color:#EBCB8B;">}</span><span style="color:#A3BE8C;">&#39;</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>timed 函数用了 contextmanager 装饰器，把协程的运行结果 yield 出来，执行结束后还计算了耗时：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> from</span><span style="color:#D8DEE9FF;"> contextmanager </span><span style="color:#81A1C1;">import</span><span style="color:#81A1C1;"> *</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> with</span><span style="color:#88C0D0;"> timed</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> as</span><span style="color:#D8DEE9FF;"> rv</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span><span style="color:#ECEFF4;">:</span><span style="color:#88C0D0;">     print</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">f</span><span style="color:#A3BE8C;">&#39;Result: </span><span style="color:#EBCB8B;">{</span><span style="color:#D8DEE9FF;">rv</span><span style="color:#EBCB8B;">}</span><span style="color:#A3BE8C;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Result</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">A</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">B</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Cost</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3.0052654459999992</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>大家先体会一下。在 Python 3.7 添加了 asynccontextmanager，也就是异步版本的 contextmanager，适合异步函数的执行，上例可以这么改：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">asynccontextmanager</span></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> async_timed</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">func</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    start </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> time</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">perf_counter</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">    yield</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> func</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">f</span><span style="color:#A3BE8C;">&#39;Cost: </span><span style="color:#EBCB8B;">{</span><span style="color:#D8DEE9FF;">time</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">perf_counter</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> -</span><span style="color:#D8DEE9FF;"> start</span><span style="color:#EBCB8B;">}</span><span style="color:#A3BE8C;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    async</span><span style="color:#81A1C1;"> with</span><span style="color:#88C0D0;"> async_timed</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> as</span><span style="color:#D8DEE9FF;"> rv</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#88C0D0;">        print</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">f</span><span style="color:#A3BE8C;">&#39;Result: </span><span style="color:#EBCB8B;">{</span><span style="color:#D8DEE9FF;">rv</span><span style="color:#EBCB8B;">}</span><span style="color:#A3BE8C;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">In </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Result</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">A</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">B</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Cost</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3.00414147500004</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>async 版本的 with 要用 <code>async with</code>，另外要注意 <code>yield await func()</code> 这句，相当于 yield +<code>await func()</code></p><p>PS: contextmanager 和 asynccontextmanager 最好的理解方法是去看源码注释，可以看延伸阅读链接 2，另外延伸阅读链接 3 包含的 PR 中相关的测试代码部分也能帮助你理解。</p><h3 id="_2-5-延伸阅读" tabindex="-1"><a class="header-anchor" href="#_2-5-延伸阅读"><span>2.5 延伸阅读</span></a></h3><ol><li><a href="https://github.com/python/cpython/blob/3.7/Lib/asyncio/tasks.py#L574" target="_blank" rel="noopener noreferrer">https://github.com/python/cpython/blob/3.7/Lib/asyncio/tasks.py#L574</a></li><li><a href="https://github.com/python/cpython/blob/3.7/Lib/contextlib.py#L243" target="_blank" rel="noopener noreferrer">https://github.com/python/cpython/blob/3.7/Lib/contextlib.py#L243</a></li><li><a href="https://github.com/python/cpython/pull/360/" target="_blank" rel="noopener noreferrer">https://github.com/python/cpython/pull/360/</a></li></ol><h2 id="_3-解密协程运行时" tabindex="-1"><a class="header-anchor" href="#_3-解密协程运行时"><span>3. 解密协程运行时</span></a></h2><p>说了这么多，现在，我们不妨来深入代码底层看看。有了前面的知识做基础，你应该很容易理解这两段代码。</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_1</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_1 start</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_1 done</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_2</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_2 start</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_2 done</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">before await</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#88C0D0;"> worker_1</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">awaited worker_1</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#88C0D0;"> worker_2</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">awaited worker_2</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;">time asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">########## 输出 ##########</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">before </span><span style="color:#81A1C1;">await</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_1 start</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_1 done</span></span>
<span class="line"><span style="color:#D8DEE9FF;">awaited worker_1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_2 start</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_2 done</span></span>
<span class="line"><span style="color:#D8DEE9FF;">awaited worker_2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Wall time</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3</span><span style="color:#D8DEE9FF;"> s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_1</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_1 start</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_1 done</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_2</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_2 start</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">worker_2 done</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    task1 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">worker_1</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    task2 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">worker_2</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">before await</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> task1</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">awaited worker_1</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> task2</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">awaited worker_2</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;">time asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">########## 输出 ##########</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">before </span><span style="color:#81A1C1;">await</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_1 start</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_2 start</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_1 done</span></span>
<span class="line"><span style="color:#D8DEE9FF;">awaited worker_1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">worker_2 done</span></span>
<span class="line"><span style="color:#D8DEE9FF;">awaited worker_2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Wall time</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2.01</span><span style="color:#D8DEE9FF;"> s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过，第二个代码，到底发生了什么呢？为了让你更详细了解到协程和线程的具体区别，这里我详细地分析了整个过程。步骤有点多，别着急，我们慢慢来看。</p><ol><li><code>asyncio.run(main())</code>，程序进入 <code>main()</code> 函数，事件循环开启；</li><li>task1 和 task2 任务被创建，并进入事件循环等待运行；运行到 print，输出 <code>&#39;before await&#39;</code>；</li><li>await task1 执行，用户选择从当前的主任务中切出，事件调度器开始调度 <code>worker_1</code>；</li><li><code>worker_1</code> 开始运行，运行 print 输出 <code>&#39;worker_1 start&#39;</code>，然后运行到 <code>await asyncio.sleep(1)</code>， 从当前任务切出，事件调度器开始调度 <code>worker_2</code>；</li><li><code>worker_2</code> 开始运行，运行 print 输出 <code>&#39;worker_2 start&#39;</code>，然后运行 <code>await asyncio.sleep(2)</code> 从当前任务切出；</li><li>以上所有事件的运行时间，都应该在 1ms 到 10ms 之间，甚至可能更短，事件调度器从这个时候开始暂停调度；</li><li>一秒钟后，<code>worker_1</code> 的 sleep 完成，事件调度器将控制权重新传给 <code>task_1</code>，输出 <code>&#39;worker_1 done&#39;</code>，<code>task_1</code> 完成任务，从事件循环中退出；</li><li><code>await task1</code> 完成，事件调度器将控制器传给主任务，输出 <code>&#39;awaited worker_1&#39;</code>，·然后在 <code>await task2</code> 处继续等待；</li><li>两秒钟后，<code>worker_2</code> 的 sleep 完成，事件调度器将控制权重新传给 <code>task_2</code>，输出 <code>&#39;worker_2 done&#39;</code>，<code>task_2</code> 完成任务，从事件循环中退出；</li><li>主任务输出 <code>&#39;awaited worker_2&#39;</code>，协程全任务结束，事件循环结束。</li></ol><p>接下来，我们进阶一下。如果我们想给某些协程任务限定运行时间，一旦超时就取消，又该怎么做呢？再进一步，如果某些协程运行时出现错误，又该怎么处理呢？同样的，来看代码。</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_1</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_2</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 2</span><span style="color:#81A1C1;"> /</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> worker_3</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    task_1 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">worker_1</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    task_2 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">worker_2</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    task_3 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">worker_3</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    task_3</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cancel</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">    res </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gather</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">task_1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> task_2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> task_3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> return_exceptions</span><span style="color:#81A1C1;">=True</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">res</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;">time asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">########## 输出 ##########</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ZeroDivisionError</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">division by zero</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">),</span><span style="color:#88C0D0;"> CancelledError</span><span style="color:#ECEFF4;">()]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Wall time</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span><span style="color:#D8DEE9FF;"> s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以看到，<code>worker_1</code> 正常运行，<code>worker_2</code> 运行中出现错误，<code>worker_3</code> 执行时间过长被我们 cancel 掉了，这些信息会全部体现在最终的返回结果 res 中。</p><p>不过要注意 <code>return_exceptions=True</code> 这行代码。如果不设置这个参数，错误就会完整地 throw 到我们这个执行层，从而需要 <code>try except</code> 来捕捉，这也就意味着其他还没被执行的任务会被全部取消掉。为了避免这个局面，我们将 <code>return_exceptions</code> 设置为 True 即可。</p><p>到这里，发现了没，线程能实现的，协程都能做到。那就让我们温习一下这些知识点，用协程来实现一个经典的生产者消费者模型吧。</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> random</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> consumer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#81A1C1;"> True</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        val </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#88C0D0;">        print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#EBCB8B;">{}</span><span style="color:#A3BE8C;"> get a val: </span><span style="color:#EBCB8B;">{}</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">format</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> val</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#81A1C1;">        await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> producer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">in</span><span style="color:#88C0D0;"> range</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">):</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        val </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> random</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">randint</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">        await</span><span style="color:#D8DEE9FF;"> queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">val</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">        print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#EBCB8B;">{}</span><span style="color:#A3BE8C;"> put a val: </span><span style="color:#EBCB8B;">{}</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">format</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> val</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#81A1C1;">        await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    queue </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Queue</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">    consumer_1 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">consumer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">queue</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">consumer_1</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    consumer_2 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">consumer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">queue</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">consumer_2</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">    producer_1 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">producer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">queue</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">producer_1</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    producer_2 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create_task</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">producer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">queue</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">producer_2</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    consumer_1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cancel</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    consumer_2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cancel</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gather</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">consumer_1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> consumer_2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> producer_1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> producer_2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> return_exceptions</span><span style="color:#81A1C1;">=True</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;">time asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">########## 输出 ##########</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_1 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 5</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_2 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_1 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 5</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_2 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_1 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_2 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_2 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_1 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_1 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 6</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_2 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_1 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 6</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_2 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_1 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 4</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_2 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 5</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_2 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 4</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_1 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 5</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_1 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">producer_2 put a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 8</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_1 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">consumer_2 get a val</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 8</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Wall time</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;"> s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-实战-豆瓣近日推荐电影爬虫" tabindex="-1"><a class="header-anchor" href="#_4-实战-豆瓣近日推荐电影爬虫"><span>4. 实战：豆瓣近日推荐电影爬虫</span></a></h2><p>最后，进入今天的实战环节——实现一个完整的协程爬虫。</p><p>任务描述：<a href="https://movie.douban.com/cinema/later/beijing/" target="_blank" rel="noopener noreferrer">https://movie.douban.com/cinema/later/beijing/</a> 这个页面描述了北京最近上映的电影，你能否通过 Python 得到这些电影的名称、上映时间和海报呢？这个页面的海报是缩小版的，我希望你能从具体的电影描述页面中抓取到海报。</p><p>听起来难度不是很大吧？我在下面给出了同步版本的代码和协程版本的代码，通过运行时间和代码写法的对比，希望你能对协程有更深的了解。（注意：为了突出重点、简化代码，这里我省略了异常处理。）</p><p>不过，在参考我给出的代码之前，你是不是可以自己先动手写一下、跑一下呢？</p>`,44),J=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," requests")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"from"),s("span",{style:{color:"#D8DEE9FF"}}," bs4 "),s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," BeautifulSoup")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    headers "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},'        "'),s("span",{style:{color:"#A3BE8C"}},"User-Agent"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#ECEFF4"}},' "'),s("span",{style:{color:"#A3BE8C"}},"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},"    }")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    url "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},' "'),s("span",{style:{color:"#A3BE8C"}},"https://movie.douban.com/cinema/later/beijing/"),s("span",{style:{color:"#ECEFF4"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    init_page "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," requests"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"get"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," headers"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"headers"),s("span",{style:{color:"#ECEFF4"}},")."),s("span",{style:{color:"#D8DEE9FF"}},"content")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # print(init_page)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    init_soup "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," BeautifulSoup"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"init_page"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"lxml"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # print(init_soup)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    all_movies "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," init_soup"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"div"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," id"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"showing-soon"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"    # print(all_movies)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," each_movie "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," all_movies"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find_all"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"div"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," class_"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"item"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(each_movie)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        all_a_tag "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," each_movie"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find_all"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"a"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(all_a_tag)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        all_li_tag "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," each_movie"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find_all"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"li"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(all_li_tag)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        movie_name "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," all_a_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"]."),s("span",{style:{color:"#D8DEE9FF"}},"text")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(movie_name)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        url_to_fetch "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," all_a_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"]["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"href"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(url_to_fetch)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        movie_date "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," all_li_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"0"),s("span",{style:{color:"#ECEFF4"}},"]."),s("span",{style:{color:"#D8DEE9FF"}},"text")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(movie_date)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        response_item "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," requests"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"get"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url_to_fetch"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," headers"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"headers"),s("span",{style:{color:"#ECEFF4"}},")."),s("span",{style:{color:"#D8DEE9FF"}},"content")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(response_item)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        soup_item "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," BeautifulSoup"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"response_item"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"lxml"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        img_tag "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," soup_item"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"img"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"        # print(img_tag)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"        print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#EBCB8B"}}," {}"),s("span",{style:{color:"#EBCB8B"}}," {}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"movie_name"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," movie_date"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," img_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"src"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"%"),s("span",{style:{color:"#D8DEE9FF"}},"time "),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"()")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),U=s("details",{class:"hint-container details"},[s("summary",null,"输出"),s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"风再起时 "),s("span",{style:{color:"#D8DEE9"}},"02月05日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img9"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2887039584"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"黑豹2 "),s("span",{style:{color:"#D8DEE9"}},"02月07日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img9"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886589774"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"不能流泪的悲伤 "),s("span",{style:{color:"#D8DEE9"}},"02月14日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886531289"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"蚁人与黄蜂女：量子狂潮 "),s("span",{style:{color:"#D8DEE9"}},"02月17日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886589789"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"中国乒乓之绝地反击 "),s("span",{style:{color:"#D8DEE9"}},"02月17日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img9"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2887100255"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"印式英语 "),s("span",{style:{color:"#D8DEE9"}},"02月24日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886633470"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"毒舌律师 "),s("span",{style:{color:"#D8DEE9"}},"02月24日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img9"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886619074"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"会考试的猛犸象 "),s("span",{style:{color:"#D8DEE9"}},"02月24日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img9"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2879572685"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"拨浪鼓咚咚响 "),s("span",{style:{color:"#D8DEE9"}},"02月25日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img2"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886538033"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"宇宙探索编辑部 "),s("span",{style:{color:"#D8DEE9"}},"04月01日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886529968"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"龙马精神 "),s("span",{style:{color:"#D8DEE9"}},"04月07日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img2"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2887204283"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"长空之王 "),s("span",{style:{color:"#D8DEE9"}},"04月28日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img9"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886235064"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"人生路不熟 "),s("span",{style:{color:"#D8DEE9"}},"04月28日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2887091779"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"检察风云 "),s("span",{style:{color:"#D8DEE9"}},"04月29日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886533208"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"请别相信她 "),s("span",{style:{color:"#D8DEE9"}},"05月20日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886540928"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"伟大的胜利 "),s("span",{style:{color:"#D8DEE9"}},"09月30日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img1"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2886621940"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"CPU times"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}}," user "),s("span",{style:{color:"#B48EAD"}},"564"),s("span",{style:{color:"#D8DEE9FF"}}," ms"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," sys"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 29.9"),s("span",{style:{color:"#D8DEE9FF"}}," ms"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," total"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 594"),s("span",{style:{color:"#D8DEE9FF"}}," ms")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Wall time"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 19.7"),s("span",{style:{color:"#D8DEE9FF"}}," s")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])])],-1),G=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," aiohttp")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"from"),s("span",{style:{color:"#D8DEE9FF"}}," bs4 "),s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," BeautifulSoup")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"header "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},'    "'),s("span",{style:{color:"#A3BE8C"}},"User-Agent"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#ECEFF4"}},' "'),s("span",{style:{color:"#A3BE8C"}},"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," fetch_content"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    async"),s("span",{style:{color:"#81A1C1"}}," with"),s("span",{style:{color:"#D8DEE9FF"}}," aiohttp"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"ClientSession"),s("span",{style:{color:"#ECEFF4"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9"}},"        headers"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"header"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," connector"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}},"aiohttp"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"TCPConnector"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"ssl"),s("span",{style:{color:"#81A1C1"}},"=False"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#ECEFF4"}},"    )"),s("span",{style:{color:"#81A1C1"}}," as"),s("span",{style:{color:"#D8DEE9FF"}}," session"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"        async"),s("span",{style:{color:"#81A1C1"}}," with"),s("span",{style:{color:"#D8DEE9FF"}}," session"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"get"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},")"),s("span",{style:{color:"#81A1C1"}}," as"),s("span",{style:{color:"#D8DEE9FF"}}," response"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"            return"),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," response"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"text"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"():")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    url "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},' "'),s("span",{style:{color:"#A3BE8C"}},"https://movie.douban.com/cinema/later/beijing/"),s("span",{style:{color:"#ECEFF4"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    init_page "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#88C0D0"}}," fetch_content"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    init_soup "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," BeautifulSoup"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"init_page"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"lxml"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    movie_names"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," urls_to_fetch"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," movie_dates "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," [],"),s("span",{style:{color:"#ECEFF4"}}," [],"),s("span",{style:{color:"#ECEFF4"}}," []")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    all_movies "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," init_soup"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"div"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," id"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"showing-soon"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," each_movie "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," all_movies"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find_all"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"div"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9"}}," class_"),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#A3BE8C"}},"item"),s("span",{style:{color:"#ECEFF4"}},'"'),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        all_a_tag "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," each_movie"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find_all"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"a"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        all_li_tag "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," each_movie"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find_all"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"li"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        movie_names"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"append"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"all_a_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"]."),s("span",{style:{color:"#D8DEE9FF"}},"text"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        urls_to_fetch"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"append"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"all_a_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"]["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"href"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        movie_dates"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"append"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"all_li_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#B48EAD"}},"0"),s("span",{style:{color:"#ECEFF4"}},"]."),s("span",{style:{color:"#D8DEE9FF"}},"text"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#88C0D0"}},"fetch_content"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},")"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls_to_fetch"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    pages "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#81A1C1"}}," await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"*"),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," movie_name"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," movie_date"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," page "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#88C0D0"}}," zip"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"movie_names"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," movie_dates"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," pages"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        soup_item "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," BeautifulSoup"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"page"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"lxml"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        img_tag "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," soup_item"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"find"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"img"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"        print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#EBCB8B"}}," {}"),s("span",{style:{color:"#EBCB8B"}}," {}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"movie_name"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," movie_date"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," img_tag"),s("span",{style:{color:"#ECEFF4"}},"["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"src"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"# %time asyncio.run(main())")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"if"),s("span",{style:{color:"#D8DEE9FF"}}," __name__ "),s("span",{style:{color:"#81A1C1"}},"=="),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"__main__"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    start_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    loops "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"get_event_loop"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    loops"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run_until_complete"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"())")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," -"),s("span",{style:{color:"#D8DEE9FF"}}," start_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"########## 输出 ##########")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"阿拉丁 "),s("span",{style:{color:"#D8DEE9"}},"05月24日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img3"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2553992741"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"龙珠超：布罗利 "),s("span",{style:{color:"#D8DEE9"}},"05月24日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img3"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2557371503"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"五月天人生无限公司 "),s("span",{style:{color:"#D8DEE9"}},"05月24日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img3"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2554324453"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"... ...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"直播攻略 "),s("span",{style:{color:"#D8DEE9"}},"06月04日"),s("span",{style:{color:"#D8DEE9FF"}}," https"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#81A1C1"}},"//"),s("span",{style:{color:"#D8DEE9FF"}},"img3"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"doubanio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"com"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"view"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"photo"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"s_ratio_poster"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"public"),s("span",{style:{color:"#81A1C1"}},"/"),s("span",{style:{color:"#D8DEE9FF"}},"p2555957974"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#D8DEE9FF"}},"jpg")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Wall time"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 4.98"),s("span",{style:{color:"#D8DEE9FF"}}," s")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),Q=e('<h2 id="_5-总结" tabindex="-1"><a class="header-anchor" href="#_5-总结"><span>5. 总结</span></a></h2><p>到这里，今天的主要内容就讲完了。今天我用了较长的篇幅，从一个简单的爬虫开始，到一个真正的爬虫结束，在中间穿插讲解了 Python 协程最新的基本概念和用法。这里带你简单复习一下。</p><ul><li>协程和多线程的区别，主要在于两点，一是协程为单线程；二是协程由用户决定，在哪些地方交出控制权，切换到下一个任务。</li><li>协程的写法更加简洁清晰，把 async / await 语法和 <code>create_task</code> 结合来用，对于中小级别的并发需求已经毫无压力。</li><li>写协程程序的时候，你的脑海中要有清晰的事件循环概念，知道程序在什么时候需要暂停、等待 I/O，什么时候需要一并执行到底。</li></ul><p>最后的最后，请一定不要轻易炫技。多线程模型也一定有其优点，一个真正牛逼的程序员，应该懂得，在什么时候用什么模型能达到工程上的最优，而不是自觉某个技术非常牛逼，所有项目创造条件也要上。技术是工程，而工程则是时间、资源、人力等纷繁复杂的事情的折衷。</p><h2 id="_6-思考题" tabindex="-1"><a class="header-anchor" href="#_6-思考题"><span>6. 思考题</span></a></h2><p>最后给你留一个思考题。协程怎么实现回调函数呢？欢迎留言和我讨论，也欢迎你把这篇文章分享给你的同事朋友，我们一起交流，一起进步。</p><h2 id="_7-评论" tabindex="-1"><a class="header-anchor" href="#_7-评论"><span>7. 评论</span></a></h2><h3 id="_7-1-讲师" tabindex="-1"><a class="header-anchor" href="#_7-1-讲师"><span>7.1 讲师</span></a></h3><p>发现评论区好多朋友说无法运行，在这里统一解释下：</p><ol><li><code>%time</code> 是 jupyter notebook 自带的语法糖，用来统计一行命令的运行时间；如果你的运行时是纯粹的命令行 python，或者 pycharm，那么请把 <code>%time</code> 删掉，自己用传统的时间戳方法来记录时间也可以；或者使用 jupyter notebook</li><li>我的本地解释器是 Anaconda Python 3.7.3，亲测 windows / ubuntu 均可正常运行，如无法执行可以试试 <code>pip install nest-asyncio</code>，依然无法解决请尝试安装 Anaconda Python</li><li>这次代码因为使用了较新的 API，所以需要较新的版本号，但是朋友们依然出现了一些运行时问题，这里先表示下歉意；同时也想说明的是，在提问之前自己经过充分搜索，尝试后解决问题，带来的快感，和能力的提升，相应也是很大的，一门工程最需要的是 hands on dirty work（动手做脏活），才能让自己的能力得到本质的提升，加油！</li></ol><hr><h3 id="_7-2-讲师" tabindex="-1"><a class="header-anchor" href="#_7-2-讲师"><span>7.2 讲师</span></a></h3><p><strong>思考题答案：</strong></p><p>在 Python 3.7 及以上的版本中，我们对 task 对象调用 <code>add_done_callback() </code>函数，即可绑定特定回调函数。回调函数接受一个 future 对象，可以通过 <code>future.result()</code> 来获取协程函数的返回值。</p><p><strong>示例如下：</strong></p>',15),X=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," tasks"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"add_done_callback"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"lambda"),s("span",{style:{color:"#D8DEE9"}}," future"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#88C0D0"}}," print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"result: "),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," future"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"result"),s("span",{style:{color:"#ECEFF4"}},"()))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"*"),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"%"),s("span",{style:{color:"#D8DEE9FF"}},"time asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#616E88"}},"# 输出：")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"crawling url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"result"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}},"  OK url_1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"result"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}},"  OK url_2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"result"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}},"  OK url_3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"result"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#D8DEE9FF"}},"  OK url_4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"Wall time"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#B48EAD"}}," 4"),s("span",{style:{color:"#D8DEE9FF"}}," s")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),V=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," time")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," tasks"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"add_done_callback"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"lambda"),s("span",{style:{color:"#D8DEE9"}}," future"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#88C0D0"}}," print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"result: "),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," future"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"result"),s("span",{style:{color:"#ECEFF4"}},"()))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"*"),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#D8DEE9FF"}},"start_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#81A1C1"}},"await"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#88C0D0"}},"print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," -"),s("span",{style:{color:"#D8DEE9FF"}}," start_time"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),H=s("div",{class:"language-python line-numbers-mode","data-highlighter":"shiki","data-ext":"python","data-title":"python",style:{"background-color":"#2e3440ff",color:"#d8dee9ff"}},[s("pre",{class:"shiki nord vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"import"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," time")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"url"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#88C0D0"}},"    print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"crawling "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    sleep_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#88C0D0"}}," int"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"split"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"_"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},")["),s("span",{style:{color:"#81A1C1"}},"-"),s("span",{style:{color:"#B48EAD"}},"1"),s("span",{style:{color:"#ECEFF4"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"sleep"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"sleep_time"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    return"),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"OK "),s("span",{style:{color:"#EBCB8B"}},"{}"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"format"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"async"),s("span",{style:{color:"#81A1C1"}}," def"),s("span",{style:{color:"#88C0D0"}}," main"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9"}},"urls"),s("span",{style:{color:"#ECEFF4"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"    tasks "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#ECEFF4"}}," ["),s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"create_task"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"crawl_page"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"url"),s("span",{style:{color:"#ECEFF4"}},"))"),s("span",{style:{color:"#81A1C1"}}," for"),s("span",{style:{color:"#D8DEE9FF"}}," url "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," urls"),s("span",{style:{color:"#ECEFF4"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    for"),s("span",{style:{color:"#D8DEE9FF"}}," task "),s("span",{style:{color:"#81A1C1"}},"in"),s("span",{style:{color:"#D8DEE9FF"}}," tasks"),s("span",{style:{color:"#ECEFF4"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D8DEE9FF"}},"        task"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"add_done_callback"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"lambda"),s("span",{style:{color:"#D8DEE9"}}," future"),s("span",{style:{color:"#ECEFF4"}},":"),s("span",{style:{color:"#88C0D0"}}," print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"result: "),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#D8DEE9FF"}}," future"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"result"),s("span",{style:{color:"#ECEFF4"}},"()))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#81A1C1"}},"    await"),s("span",{style:{color:"#D8DEE9FF"}}," asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"gather"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#81A1C1"}},"*"),s("span",{style:{color:"#D8DEE9FF"}},"tasks"),s("span",{style:{color:"#ECEFF4"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#D8DEE9FF"}},"start_time "),s("span",{style:{color:"#81A1C1"}},"="),s("span",{style:{color:"#D8DEE9FF"}}," time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#D8DEE9FF"}},"asyncio"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"run"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#88C0D0"}},"main"),s("span",{style:{color:"#ECEFF4"}},"(["),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#A3BE8C"}},"url_1"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_2"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_3"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},","),s("span",{style:{color:"#ECEFF4"}}," '"),s("span",{style:{color:"#A3BE8C"}},"url_4"),s("span",{style:{color:"#ECEFF4"}},"'"),s("span",{style:{color:"#ECEFF4"}},"]))")]),l(`
`),s("span",{class:"line highlighted"},[s("span",{style:{color:"#88C0D0"}},"print"),s("span",{style:{color:"#ECEFF4"}},"("),s("span",{style:{color:"#D8DEE9FF"}},"time"),s("span",{style:{color:"#ECEFF4"}},"."),s("span",{style:{color:"#88C0D0"}},"time"),s("span",{style:{color:"#ECEFF4"}},"()"),s("span",{style:{color:"#81A1C1"}}," -"),s("span",{style:{color:"#D8DEE9FF"}}," start_time"),s("span",{style:{color:"#ECEFF4"}},")")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),Z=e(`<hr><h3 id="_7-3-helloworld" tabindex="-1"><a class="header-anchor" href="#_7-3-helloworld"><span>7.3 helloworld</span></a></h3><p>说一下我对 await 的理解： 开发者要提前知道一个任务的哪个环节会造成 I/O 阻塞，然后把这个环节的代码异步化处理，并且通过 await来标识在任务的该环节中断该任务执行，从而去执行下一个事件循环任务。这样可以充分利用 CPU 资源，避免 CPU 等待 I/O 造成 CPU 资源白白浪费。当之前任务的那个环节的 I/O 完成后，线程可以从 await 获取返回值，然后继续执行没有完成的剩余代码。 由上面分析可知，如果一个任务不涉及到网络或磁盘 I/O 这种耗时的操作，而只有 CPU 计算和内存 I/O 的操作时，协程并发的性能还不如单线程 loop 循环的性能高。</p><hr><h3 id="_7-4-大侠110" tabindex="-1"><a class="header-anchor" href="#_7-4-大侠110"><span>7.4 大侠110</span></a></h3><p>感觉还是有很多人看不懂，我试着用通俗的语句讲一下：协成里面重要的是一个关键字 await 的理解，async 表示其修饰的是协程任务即 task，await 表示的是当线程执行到这一句，此时该 task 在此处挂起，然后调度器去执行其他的 task，当这个挂起的部分处理完，会调用回掉函数告诉调度器我已经执行完了，那么调度器就返回来处理这个 task 的余下语句。</p><hr><h3 id="_7-5-airnm-毁" tabindex="-1"><a class="header-anchor" href="#_7-5-airnm-毁"><span>7.5 Airnm.毁</span></a></h3><p>豆瓣那个发现 <code>requests.get(url).content/text</code> 返回都为空，然后打了下 status_code 发现是 418，网上找 418 的解释，一般是网站反爬虫基础机制，需要加请求头模仿浏览器就可跳过，改为下面的样子就可通过：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">url </span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">https://movie.douban.com/cinema/later/beijing/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">head</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">    &#39;</span><span style="color:#A3BE8C;">User-Agent</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)Chrome/81.0.4044.113 Safari/537.36</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &#39;</span><span style="color:#A3BE8C;">Referer</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">https://time.geekbang.org/column/article/101855</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &#39;</span><span style="color:#A3BE8C;">Connection</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">keep-alive</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">res </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> requests</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">url</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> headers</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">head</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>作者回复: 👍，可能是增加了反爬虫机制</p></blockquote><hr><h3 id="_7-7-长期规划" tabindex="-1"><a class="header-anchor" href="#_7-7-长期规划"><span>7.7 长期规划</span></a></h3><p>老师，在最后那个协程例子中为何没用 requests 库呢？是因为它不支持协程吗</p><blockquote><p>作者回复: 协程使用的是 aiohttp 并发网络 io 库，因此就不需要 requests 了</p></blockquote><h2 id="_8-报错处理" tabindex="-1"><a class="header-anchor" href="#_8-报错处理"><span>8. 报错处理</span></a></h2><h3 id="_8-1-runtimeerror-asyncio-run-cannot-be-called-from-a-running-event-loop" tabindex="-1"><a class="header-anchor" href="#_8-1-runtimeerror-asyncio-run-cannot-be-called-from-a-running-event-loop"><span>8.1 RuntimeError: asyncio.run() cannot be called from a running event loop</span></a></h3><p>学习协程异步操作出现的问题：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> time</span></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> func_4</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">营养快线</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#616E88;">    # time.sleep(3) </span></span>
<span class="line"><span style="color:#616E88;">    # print(&quot;娃哈哈&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> __name__</span><span style="color:#81A1C1;">==</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">__main__</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    g </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> func_4</span><span style="color:#ECEFF4;">()</span><span style="color:#616E88;"> # 此时的函数是异步协程函数，此时函数执行得到一个协程对象</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">g</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码报错：</p><p><code>RuntimeError: asyncio.run() cannot be called from a running event loop</code></p><p>意思大致就是 jupyter 已经运行了 loop，无需自己激活，修改为：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> time</span></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> func_4</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">营养快线</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#616E88;">    # time.sleep(3) </span></span>
<span class="line"><span style="color:#616E88;">    # print(&quot;娃哈哈&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> __name__</span><span style="color:#81A1C1;">==</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">__main__</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    g </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> func_4</span><span style="color:#ECEFF4;">()</span><span style="color:#616E88;"> # 此时的函数是异步协程函数，此时函数执行得到一个协程对象</span></span>
<span class="line"><span style="color:#616E88;">    #asyncio.run(g)</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> g</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-syntaxerror-await-outside-async-function的原因与解决" tabindex="-1"><a class="header-anchor" href="#_8-2-syntaxerror-await-outside-async-function的原因与解决"><span>8.2 SyntaxError: ‘await‘ outside async function的原因与解决</span></a></h3><p>我们看下面这个代码，表面上没什么问题：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> do1</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">两秒过去了</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> do2</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">两秒又过去了</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> do3</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">4</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">四秒过去了</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">await</span><span style="color:#88C0D0;"> do1</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">await</span><span style="color:#88C0D0;"> do2</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">await</span><span style="color:#88C0D0;"> do3</span><span style="color:#ECEFF4;">()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但运行了以后会这样报错：</p><figure><img src="`+u+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>原因：</strong> await 是要和创建协程时 async 一起搭配使用的，直接使用 await 就会找不到他所在的函数的，于是报错在函数外。</p><p>解决方法：</p><ul><li>创建任务单</li><li>创建事件</li><li>实现并发运行</li></ul><p>改进代码：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> asyncio</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> do1</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">两秒过去了</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> do2</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">三秒过去了</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> def</span><span style="color:#88C0D0;"> do3</span><span style="color:#ECEFF4;">():</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">4</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#88C0D0;">    print</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">四秒过去了</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">renwu </span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;"> [</span><span style="color:#88C0D0;">do1</span><span style="color:#ECEFF4;">(),</span><span style="color:#88C0D0;"> do2</span><span style="color:#ECEFF4;">(),</span><span style="color:#88C0D0;"> do3</span><span style="color:#ECEFF4;">()]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">loops </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get_event_loop</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#D8DEE9FF;">loops</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run_until_complete</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">asyncio</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">wait</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">renwu</span><span style="color:#ECEFF4;">))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+v+'" alt="image-20230130101219537" tabindex="0" loading="lazy"><figcaption>image-20230130101219537</figcaption></figure><p>完成的很顺利。</p><p>欢迎关注我公众号：AI悦创，有更多更好玩的等你发现！</p><details class="hint-container details"><summary>公众号：AI悦创【二维码】</summary><figure><img src="'+E+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></details><div class="hint-container info"><p class="hint-container-title">AI悦创·编程一对一</p><p>AI悦创·推出辅导班啦，包括「Python 语言辅导班、C++ 辅导班、java 辅导班、算法/数据结构辅导班、少儿编程、pygame 游戏开发」，全部都是一对一教学：一对一辅导 + 一对一答疑 + 布置作业 + 项目实践等。当然，还有线下线上摄影课程、Photoshop、Premiere 一对一教学、QQ、微信在线，随时响应！微信：Jiabcdefh</p><p>C++ 信息奥赛题解，长期更新！长期招收一对一中小学信息奥赛集训，莆田、厦门地区有机会线下上门，其他地区线上。微信：Jiabcdefh</p><p>方法一：<a href="http://wpa.qq.com/msgrd?v=3&amp;uin=1432803776&amp;site=qq&amp;menu=yes" target="_blank" rel="noopener noreferrer">QQ</a></p><p>方法二：微信：Jiabcdefh</p></div><figure><img src="'+F+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',39);function $(Y,ss){const c=t("CodeTabs"),r=t("Tabs");return C(),y("div",null,[b,p(c,{id:"92",data:[{id:"old"},{id:"Run in Jupyter Notebook"},{id:"Python file"}],"tab-id":"python"},{title0:n(({value:a,isActive:o})=>[l("old")]),title1:n(({value:a,isActive:o})=>[l("Run in Jupyter Notebook")]),title2:n(({value:a,isActive:o})=>[l("Python file")]),tab0:n(({value:a,isActive:o})=>[A]),tab1:n(({value:a,isActive:o})=>[h]),tab2:n(({value:a,isActive:o})=>[_]),_:1}),g,p(c,{id:"237",data:[{id:"old"},{id:"Pycharm"}],"tab-id":"python"},{title0:n(({value:a,isActive:o})=>[l("old")]),title1:n(({value:a,isActive:o})=>[l("Pycharm")]),tab0:n(({value:a,isActive:o})=>[B]),tab1:n(({value:a,isActive:o})=>[f]),_:1}),k,p(r,{id:"264",data:[{id:"Ipython"},{id:"Pycharm"},{id:"coro1.py"}]},{title0:n(({value:a,isActive:o})=>[l("Ipython")]),title1:n(({value:a,isActive:o})=>[l("Pycharm")]),title2:n(({value:a,isActive:o})=>[l("coro1.py")]),tab0:n(({value:a,isActive:o})=>[w,x,T,O,P,I,S,K,q,R,j,L,N]),tab1:n(({value:a,isActive:o})=>[W]),tab2:n(({value:a,isActive:o})=>[M]),_:1}),z,p(r,{id:"514",data:[{id:"正常版本"},{id:"协程版本"}]},{title0:n(({value:a,isActive:o})=>[l("正常版本")]),title1:n(({value:a,isActive:o})=>[l("协程版本")]),tab0:n(({value:a,isActive:o})=>[J,U]),tab1:n(({value:a,isActive:o})=>[G]),_:1}),Q,p(c,{id:"596",data:[{id:"old"},{id:"Run on Jupyter Notebook"},{id:"Run on Pycharm"}],"tab-id":"python"},{title0:n(({value:a,isActive:o})=>[l("old")]),title1:n(({value:a,isActive:o})=>[l("Run on Jupyter Notebook")]),title2:n(({value:a,isActive:o})=>[l("Run on Pycharm")]),tab0:n(({value:a,isActive:o})=>[X]),tab1:n(({value:a,isActive:o})=>[V]),tab2:n(({value:a,isActive:o})=>[H]),_:1}),Z])}const es=i(m,[["render",$],["__file","20.html.vue"]]),ps=JSON.parse('{"path":"/Python/Python-core-technology-and-practice/20.html","title":"20-揭秘 Python 协程","lang":"zh-CN","frontmatter":{"title":"20-揭秘 Python 协程","icon":"python","date":"2023-01-24T10:27:51.000Z","author":"AI悦创","isOriginal":true,"category":"Python 进阶","tag":["Python 进阶"],"sticky":false,"star":false,"article":true,"timeline":true,"image":false,"navbar":true,"sidebarIcon":true,"headerDepth":5,"comment":true,"lastUpdated":true,"editLink":false,"backToTop":true,"toc":true,"feed":false,"seo":false,"head":[]},"headers":[{"level":2,"title":"1. 从一个爬虫说起","slug":"_1-从一个爬虫说起","link":"#_1-从一个爬虫说起","children":[]},{"level":2,"title":"2. 补充","slug":"_2-补充","link":"#_2-补充","children":[{"level":3,"title":"2.1 asyncio.gather vs asyncio.wait","slug":"_2-1-asyncio-gather-vs-asyncio-wait","link":"#_2-1-asyncio-gather-vs-asyncio-wait","children":[]},{"level":3,"title":"2.2 asyncio.create_task vs loop.create_task vs asyncio.ensure_future","slug":"_2-2-asyncio-create-task-vs-loop-create-task-vs-asyncio-ensure-future","link":"#_2-2-asyncio-create-task-vs-loop-create-task-vs-asyncio-ensure-future","children":[]},{"level":3,"title":"2.3 shield","slug":"_2-3-shield","link":"#_2-3-shield","children":[]},{"level":3,"title":"2.4 asynccontextmanager","slug":"_2-4-asynccontextmanager","link":"#_2-4-asynccontextmanager","children":[]},{"level":3,"title":"2.5 延伸阅读","slug":"_2-5-延伸阅读","link":"#_2-5-延伸阅读","children":[]}]},{"level":2,"title":"3. 解密协程运行时","slug":"_3-解密协程运行时","link":"#_3-解密协程运行时","children":[]},{"level":2,"title":"4. 实战：豆瓣近日推荐电影爬虫","slug":"_4-实战-豆瓣近日推荐电影爬虫","link":"#_4-实战-豆瓣近日推荐电影爬虫","children":[]},{"level":2,"title":"5. 总结","slug":"_5-总结","link":"#_5-总结","children":[]},{"level":2,"title":"6. 思考题","slug":"_6-思考题","link":"#_6-思考题","children":[]},{"level":2,"title":"7. 评论","slug":"_7-评论","link":"#_7-评论","children":[{"level":3,"title":"7.1 讲师","slug":"_7-1-讲师","link":"#_7-1-讲师","children":[]},{"level":3,"title":"7.2 讲师","slug":"_7-2-讲师","link":"#_7-2-讲师","children":[]},{"level":3,"title":"7.3 helloworld","slug":"_7-3-helloworld","link":"#_7-3-helloworld","children":[]},{"level":3,"title":"7.4 大侠110","slug":"_7-4-大侠110","link":"#_7-4-大侠110","children":[]},{"level":3,"title":"7.5 Airnm.毁","slug":"_7-5-airnm-毁","link":"#_7-5-airnm-毁","children":[]},{"level":3,"title":"7.7 长期规划","slug":"_7-7-长期规划","link":"#_7-7-长期规划","children":[]}]},{"level":2,"title":"8. 报错处理","slug":"_8-报错处理","link":"#_8-报错处理","children":[{"level":3,"title":"8.1 RuntimeError: asyncio.run() cannot be called from a running event loop","slug":"_8-1-runtimeerror-asyncio-run-cannot-be-called-from-a-running-event-loop","link":"#_8-1-runtimeerror-asyncio-run-cannot-be-called-from-a-running-event-loop","children":[]},{"level":3,"title":"8.2 SyntaxError: ‘await‘ outside async function的原因与解决","slug":"_8-2-syntaxerror-await-outside-async-function的原因与解决","link":"#_8-2-syntaxerror-await-outside-async-function的原因与解决","children":[]}]}],"git":{"createdTime":1705215474000,"updatedTime":1705215474000,"contributors":[{"name":"AndersonHJB","email":"cleland1432803776@icloud.com","commits":1}]},"readingTime":{"minutes":28.3,"words":8489},"filePathRelative":"Python/Python-core-technology-and-practice/20.md","localizedDate":"2023年1月24日","copyright":{"author":"AI悦创"}}');export{es as comp,ps as data};
