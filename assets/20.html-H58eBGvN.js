import{_ as r}from"./gzh-X2g0OvFa.js";import{_ as k}from"./zsxq-YQJ_sFB4.js";import{_ as d}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as i,o as m,c as v,d as o,w as a,a as n,b as s,e as p}from"./app-d4Ha9aDR.js";const b="/assets/e04a4e460bd42f7732d1c56b1fc165cd-6BPTHp2l.jpg",y="/assets/pixel-jeff-homecoming-JkH_UJQu.gif",_="/assets/image-20230130101101621-9ROqO1Qr.png",g="/assets/image-20230130101219537-Kxss77i6.png",w={},h=p('<figure><img src="'+b+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="'+y+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>你好，我是悦创。</p><p>上一节课的最后，我们留下一个小小的悬念：生成器在 Python 2 中还扮演了一个重要角色，就是用来实现 Python 协程。</p><p>那么首先你要明白，什么是协程？</p><p>协程是实现并发编程的一种方式。一说并发，你肯定想到了多线程 / 多进程模型，没错，多线程 / 多进程，正是解决并发问题的经典模型之一。最初的互联网世界，多线程 / 多进程在服务器并发中，起到举足轻重的作用。</p><p>随着互联网的快速发展，你逐渐遇到了 C10K 瓶颈，也就是同时连接到服务器的客户达到了一万个。于是很多代码跑崩了，进程上下文切换占用了大量的资源，线程也顶不住如此巨大的压力，这时， NGINX 带着事件循环出来拯救世界了。</p><p>如果将多进程 / 多线程类比为起源于唐朝的藩镇割据，那么事件循环，就是宋朝加强的中央集权制。事件循环启动一个统一的调度器，让调度器来决定一个时刻去运行哪个任务，于是省却了多线程中启动线程、管理线程、同步锁等各种开销。同一时期的 NGINX，在高并发下能保持低资源低消耗高性能，相比 Apache 也支持更多的并发连接。</p><p>再到后来，出现了一个很有名的名词，叫做回调地狱（callback hell），手撸过 JavaScript 的朋友肯定知道我在说什么。我们大家惊喜地发现，这种工具完美地继承了事件循环的优越性，同时还能提供 async / await 语法糖，解决了执行性和可读性共存的难题。于是，协程逐渐被更多人发现并看好，也有越来越多的人尝试用 Node.js 做起了后端开发。（讲个笑话，JavaScript 是一门编程语言。）</p><p>回到我们的 Python。使用生成器，是 Python 2 开头的时代实现协程的老方法了，Python 3.7 提供了新的基于 asyncio 和 async / await 的方法。我们这节课，同样的，跟随时代，抛弃掉不容易理解、也不容易写的旧的基于生成器的方法，直接来讲新方法。</p><p>我们先从一个爬虫实例出发，用清晰的讲解思路，带你结合实战来搞懂这个不算特别容易理解的概念。之后，我们再由浅入深，直击协程的核心。</p><h2 id="_1-从一个爬虫说起" tabindex="-1"><a class="header-anchor" href="#_1-从一个爬虫说起" aria-hidden="true">#</a> 1. 从一个爬虫说起</h2><p>爬虫，就是互联网的蜘蛛，在搜索引擎诞生之时，与其一同来到世上。爬虫每秒钟都会爬取大量的网页，提取关键信息后存储在数据库中，以便日后分析。爬虫有非常简单的 Python 十行代码实现，也有 Google 那样的全球分布式爬虫的上百万行代码，分布在内部上万台服务器上，对全世界的信息进行嗅探。</p><p>话不多说，我们先看一个简单的爬虫例子：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">crawl_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;crawling {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep_time <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;_&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>sleep_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;OK {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
        crawl_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

<span class="token operator">%</span>time main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;url_1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url_2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url_3&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url_4&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">########## 输出 ##########</span>

crawling url_1
OK url_1
crawling url_2
OK url_2
crawling url_3
OK url_3
crawling url_4
OK url_4
Wall time<span class="token punctuation">:</span> <span class="token number">10</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（注意：本节的主要目的是协程的基础概念，因此我们简化爬虫的 scrawl_page 函数为休眠数秒，休眠时间取决于 url 最后的那个数字。）</p><p>这是一个很简单的爬虫，<code>main()</code> 函数执行时，调取 <code>crawl_page()</code> 函数进行网络通信，经过若干秒等待后收到结果，然后执行下一个。</p><p>看起来很简单，但你仔细一算，它也占用了不少时间，五个页面分别用了 1 秒到 4 秒的时间，加起来一共用了 10 秒。这显然效率低下，该怎么优化呢？</p><p>于是，一个很简单的思路出现了——我们这种爬取操作，完全可以并发化。我们就来看看使用协程怎么写。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">crawl_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;crawling {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep_time <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;_&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>sleep_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;OK {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
        <span class="token keyword">await</span> crawl_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

<span class="token operator">%</span>time asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;url_1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url_2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url_3&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url_4&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">########## 输出 ##########</span>

crawling url_1
OK url_1
crawling url_2
OK url_2
crawling url_3
OK url_3
crawling url_4
OK url_4
Wall time<span class="token punctuation">:</span> <span class="token number">10</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看到这段代码，你应该发现了，在 Python 3.7 以上版本中，使用协程写异步程序非常简单。</p><p>首先来看 import asyncio，这个库包含了大部分我们实现协程所需的魔法工具。</p><p>async 修饰词声明异步函数，于是，这里的 crawl_page 和 main 都变成了异步函数。而调用异步函数，我们便可得到一个协程对象（coroutine object）。</p><p>举个例子，如果你 <code>print(crawl_page(&#39;&#39;))</code>，便会输出，提示你这是一个 Python 的协程对象，而并不会真正执行这个函数。</p><p>再来说说协程的执行。执行协程有多种方法，这里我介绍一下常用的三种。</p><p>首先，我们可以通过 await 来调用。await 执行的效果，和 Python 正常执行是一样的，也就是说程序会阻塞在这里，进入被调用的协程函数，执行完毕返回后再继续，而这也是 await 的字面意思。代码中 <code>await asyncio.sleep(sleep_time)</code> 会在这里休息若干秒，<code>await crawl_page(url) </code>则会执行 <code>crawl_page()</code> 函数。</p><p>其次，我们可以通过 <code>asyncio.create_task()</code> 来创建任务，这个我们下节课会详细讲一下，你先简单知道即可。</p><p>最后，我们需要 <code>asyncio.run</code> 来触发运行。<code>asyncio.run</code> 这个函数是 Python 3.7 之后才有的特性，可以让 Python 的协程接口变得非常简单，你不用去理会事件循环怎么定义和怎么使用的问题（我们会在下面讲）。一个非常好的编程规范是，<code>asyncio.run(main())</code> 作为主程序的入口函数，在程序运行周期内，只调用一次 <code>asyncio.run</code>。</p><p>这样，你就大概看懂了协程是怎么用的吧。不妨试着跑一下代码，欸，怎么还是 10 秒？</p><p>10 秒就对了，还记得上面所说的，await 是同步调用，因此， <code>crawl_page(url)</code> 在当前的调用结束之前，是不会触发下一次调用的。于是，这个代码效果就和上面完全一样了，相当于我们用异步接口写了个同步代码。</p><p>现在又该怎么办呢？</p><p>其实很简单，也正是我接下来要讲的协程中的一个重要概念，任务（Task）。老规矩，先看代码。</p>`,32),f=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` asyncio

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'crawling {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'_'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'OK {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" task "),n("span",{class:"token keyword"},"in"),s(" tasks"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"await"),s(` task

`),n("span",{class:"token operator"},"%"),s("time asyncio"),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"########## 输出 ##########"),s(`

crawling url_1
crawling url_2
crawling url_3
crawling url_4
OK url_1
OK url_2
OK url_3
OK url_4
Wall time`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"3.99"),s(` s
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),x=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{python:"",class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` time
`),n("span",{class:"token keyword"},"import"),s(` asyncio


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"crawling {}"'),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token comment"},"# time.sleep(sleep_time)"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"OK {}"'),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" task "),n("span",{class:"token keyword"},"in"),s(" tasks"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"await"),s(` task
    `),n("span",{class:"token comment"},"# for url in urls:"),s(`
    `),n("span",{class:"token comment"},"#     await crawl_page(url)"),s(`
`),n("span",{class:"token comment"},"# %time asyncio.run(main(['url_1', 'url_2', 'url_3', 'url_4']))"),s(`
start_time `),n("span",{class:"token operator"},"="),s(" time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"await"),s(" main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" start_time"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"########## 输出 ##########"),s(`
crawling url_1
crawling url_2
crawling url_3
crawling url_4
OK url_1
OK url_2
OK url_3
OK url_4
`),n("span",{class:"token number"},"4.005578994750977"),s(`
`)])]),n("div",{class:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," "),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),O=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{python:"",class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` time
`),n("span",{class:"token keyword"},"import"),s(` asyncio


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"crawling {}"'),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token comment"},"# time.sleep(sleep_time)"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"OK {}"'),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" task "),n("span",{class:"token keyword"},"in"),s(" tasks"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"await"),s(` task
    `),n("span",{class:"token comment"},"# for url in urls:"),s(`
    `),n("span",{class:"token comment"},"#     await crawl_page(url)"),s(`
`),n("span",{class:"token comment"},"# %time asyncio.run(main(['url_1', 'url_2', 'url_3', 'url_4']))"),s(`
start_time `),n("span",{class:"token operator"},"="),s(" time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
asyncio`),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" start_time"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," ")]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),T=p('<p>你可以看到，我们有了协程对象后，便可以通过 <code>asyncio.create_task</code> 来创建任务。任务创建后很快就会被调度执行，这样，我们的代码也不会阻塞在任务这里。所以，我们要等所有任务都结束才行，用 <code>for task in tasks: await task</code> 即可。</p><p>这次，你就看到效果了吧，<strong>结果显示，运行总时长等于运行时间最长的爬虫。</strong></p><div class="hint-container info"><p class="hint-container-title">探究协程原因</p><p><strong>举个例子🌰：</strong></p><p>目标：小 Cava 要做一道美味的鱼汤。</p><p><strong>正常的流程：</strong></p><ol><li>🐟杀鱼「3min」</li><li>🫀清洗内脏「2min」</li><li>🍳锅热入凉油「2min」</li><li>🎏加入备好的：生姜、大葱「3min」</li><li>🔆煎至：两面金黄「5min」</li><li>🎃加入凉水煮，等到煮开「15min」</li><li>开吃～</li><li>PS：煮开水：15min</li><li>⌚️Total Time：30 min</li></ol><blockquote><p>忽略细节部分，主要理解协程真谛。</p></blockquote><p><strong>更好的流程：</strong></p><ol><li>🎃煮开水：15min <ol><li>🐟杀鱼「3min」</li><li>🫀清洗内脏「2min」</li><li>🍳锅热入凉油「2min」</li><li>🎏加入备好的：生姜、大葱「3min」</li><li>🔆煎至：两面金黄「5min」</li></ol></li><li>🐟鱼加入煮开的开水，再煮 2min，直接出锅～「鱼不是程序，还是得煮出鱼汤的，而计算机就不用。」</li><li>开吃～</li><li>⌚️Total Time：17min「要是计算机的话，不需要添加煮鱼的 2min」</li></ol><hr><p>煮开水被第二种方法，类似：挂起。那挂起就没有在煮开水吗？——No，还是在继续煮开水，不会因为你挂起而停止煮开水。</p><p>那协程是什么意思？就是把耗时的、请求慢的、下载慢的，挂起继续后台下载，在下载的时候呢，去请求其他的链接🔗。</p></div><p>当然，你也可以想一想，这里用多线程应该怎么写？而如果需要爬取的页面有上万个又该怎么办呢？再对比下协程的写法，谁更清晰自是一目了然。</p><p>其实，对于执行 tasks，还有另一种做法：</p>',5),I=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` asyncio

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'crawling {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'_'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'OK {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tasks"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token operator"},"%"),s("time asyncio"),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"########## 输出 ##########"),s(`

crawling url_1
crawling url_2
crawling url_3
crawling url_4
OK url_1
OK url_2
OK url_3
OK url_4
Wall time`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"4.01"),s(` s
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),P=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(" asyncio"),n("span",{class:"token punctuation"},","),s(` time


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'crawling {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'_'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'OK {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tasks"),n("span",{class:"token punctuation"},")"),s(`

start_time `),n("span",{class:"token operator"},"="),s(" time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
asyncio`),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" start_time"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),A=p(`<p>这里的代码也很好理解。唯一要注意的是，<code>*tasks</code> 解包列表，将列表变成了函数的参数；与之对应的是， <code>** dict</code> 将字典变成了函数的参数。</p><p>另外，<code>asyncio.create_task</code>，<code>asyncio.run</code> 这些函数都是 Python 3.7 以上的版本才提供的，自然，相比于旧接口它们也更容易理解和阅读。</p><h2 id="_2-补充" tabindex="-1"><a class="header-anchor" href="#_2-补充" aria-hidden="true">#</a> 2. 补充</h2><h3 id="_2-1-asyncio-gather-vs-asyncio-wait" tabindex="-1"><a class="header-anchor" href="#_2-1-asyncio-gather-vs-asyncio-wait" aria-hidden="true">#</a> 2.1 asyncio.gather vs asyncio.wait</h3><p>在上面的内容，我们知道有：<code>asyncio.gather</code> 与 <code>asyncio.wait</code>，他们都可以让多个协程并发执行。那为什么提供 2 个方法呢？它们有什么区别，适用场景是怎么样的呢？其实我之前也是有点困惑，直到我读了 asyncio 的源码。我们先看 2 个协程的例子:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Suspending a&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Resuming a&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&#39;A&#39;</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Suspending b&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Resuming b&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&#39;B&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 IPython 里面用 gather 执行一下：</p>`,7),K=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[s("In "),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" return_value_a"),n("span",{class:"token punctuation"},","),s(" return_value_b "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
Suspending a
Suspending b
Resuming b
Resuming a

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" return_value_a"),n("span",{class:"token punctuation"},","),s(` return_value_b
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'A'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'B'"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),S=n("p",null,[s("Ok，"),n("code",null,"asyncio.gather"),s(" 方法的名字说明了它的用途，gather 的意思是「搜集」，也就是能够收集协程的结果，而且要注意，它会按输入协程的顺序保存的对应协程的执行结果。")],-1),C=n("p",null,[s("接着我们说 "),n("code",null,"asyncio.await"),s(" ，先执行一下：")],-1),q=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[s("In "),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" done"),n("span",{class:"token punctuation"},","),s(" pending "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"4"),n("span",{class:"token operator"},"-"),s("c7c81c0fc688"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},":"),s(" DeprecationWarning"),n("span",{class:"token punctuation"},":"),s(" The explicit passing of coroutine objects to asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"is"),s(" deprecated since Python "),n("span",{class:"token number"},"3.8"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"and"),s(" scheduled "),n("span",{class:"token keyword"},"for"),s(" removal "),n("span",{class:"token keyword"},"in"),s(" Python "),n("span",{class:"token number"},"3.11"),n("span",{class:"token punctuation"},"."),s(`
  done`),n("span",{class:"token punctuation"},","),s(" pending "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
Suspending a
Suspending b
Resuming b
Resuming a

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(` done
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(` 
`),n("span",{class:"token punctuation"},"{"),n("span",{class:"token operator"},"<"),s("Task finished name"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'Task-526'"),s(" coro"),n("span",{class:"token operator"},"="),n("span",{class:"token operator"},"<"),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(" done"),n("span",{class:"token punctuation"},","),s(" defined at "),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},"-"),s("ad0e9324f79a"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"4"),n("span",{class:"token operator"},">"),s(" result"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'A'"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},","),s(`
 `),n("span",{class:"token operator"},"<"),s("Task finished name"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'Task-527'"),s(" coro"),n("span",{class:"token operator"},"="),n("span",{class:"token operator"},"<"),s("b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(" done"),n("span",{class:"token punctuation"},","),s(" defined at "),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},"-"),s("ad0e9324f79a"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"11"),n("span",{class:"token operator"},">"),s(" result"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'B'"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},"}"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(` pending
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token builtin"},"set"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" task "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"list"),n("span",{class:"token punctuation"},"("),s("done"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(` task
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token operator"},"<"),s("Task finished name"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'Task-527'"),s(" coro"),n("span",{class:"token operator"},"="),n("span",{class:"token operator"},"<"),s("b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(" done"),n("span",{class:"token punctuation"},","),s(" defined at "),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},"-"),s("ad0e9324f79a"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"11"),n("span",{class:"token operator"},">"),s(" result"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'B'"),n("span",{class:"token operator"},">"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"9"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" task"),n("span",{class:"token punctuation"},"."),s(`result
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"9"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token operator"},"<"),s("function Task"),n("span",{class:"token punctuation"},"."),s("result"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},">"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" task"),n("span",{class:"token punctuation"},"."),s("result"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token string"},"'B'"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),j=n("p",null,[n("code",null,"asyncio.wait"),s(" 的返回值有 2 项，第一项表示完成的任务列表 (done)，第二项表示等待 (Future) 完成的任务列表 (pending)，每个任务都是一个 Task 实例，由于这 2 个任务都已经完成，所以可以执行 "),n("code",null,"task.result()"),s(" 获得协程返回值。")],-1),R=n("p",null,"Ok, 说到这里，我总结下它俩的区别的第一层区别：",-1),E=n("ol",null,[n("li",null,[n("code",null,"asyncio.gather"),s(" 封装的 Task 全程黑盒，只告诉你协程结果。")]),n("li",null,[n("code",null,"asyncio.wait"),s(" 会返回封装的 Task (包含已完成和挂起的任务)，如果你关注协程执行结果你需要从对应 Task 实例里面用 result 方法自己拿。")])],-1),B=n("p",null,[s("为什么说「第一层区别」，"),n("code",null,"asyncio.wait"),s(" 看名字可以理解为「等待」，所以返回值的第二项是 pending 集合，但是看上面的例子，pending 是空集合，那么在什么情况下，pending 里面不为空呢？这就是第二层区别："),n("code",null,"asyncio.wait"),s(" 支持选择返回的时机。")],-1),L=n("p",null,[n("code",null,"asyncio.wait"),s(" 支持一个接收参数 "),n("code",null,"return_when"),s("，在默认情况下，"),n("code",null,"asyncio.wait"),s(" 会等待全部任务完成 "),n("code",null,"(return_when='ALL_COMPLETED')"),s("，它还支持 "),n("code",null,"FIRST_COMPLETED"),s("（第一个协程完成就返回）和 "),n("code",null,"FIRST_EXCEPTION"),s("（出现第一个异常就返回）：")],-1),W=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[s("In "),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"11"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(" done"),n("span",{class:"token punctuation"},","),s(" pending "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" return_when"),n("span",{class:"token operator"},"="),s("asyncio"),n("span",{class:"token punctuation"},"."),s("tasks"),n("span",{class:"token punctuation"},"."),s("FIRST_COMPLETED"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"11"),n("span",{class:"token operator"},"-"),s("36382977e01c"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},":"),s(" DeprecationWarning"),n("span",{class:"token punctuation"},":"),s(" The explicit passing of coroutine objects to asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"is"),s(" deprecated since Python "),n("span",{class:"token number"},"3.8"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"and"),s(" scheduled "),n("span",{class:"token keyword"},"for"),s(" removal "),n("span",{class:"token keyword"},"in"),s(" Python "),n("span",{class:"token number"},"3.11"),n("span",{class:"token punctuation"},"."),s(`
  done`),n("span",{class:"token punctuation"},","),s(" pending "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" return_when"),n("span",{class:"token operator"},"="),s("asyncio"),n("span",{class:"token punctuation"},"."),s("tasks"),n("span",{class:"token punctuation"},"."),s("FIRST_COMPLETED"),n("span",{class:"token punctuation"},")"),s(`
Suspending a
Suspending b
Resuming b

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"12"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(` done
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"12"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token operator"},"<"),s("Task finished name"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'Task-1094'"),s(" coro"),n("span",{class:"token operator"},"="),n("span",{class:"token operator"},"<"),s("b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(" done"),n("span",{class:"token punctuation"},","),s(" defined at "),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},"-"),s("ad0e9324f79a"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"11"),n("span",{class:"token operator"},">"),s(" result"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'B'"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},"}"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"13"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(` pending
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"13"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token operator"},"<"),s("Task pending name"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'Task-1093'"),s(" coro"),n("span",{class:"token operator"},"="),n("span",{class:"token operator"},"<"),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(" running at "),n("span",{class:"token operator"},"<"),s("ipython"),n("span",{class:"token operator"},"-"),n("span",{class:"token builtin"},"input"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},"-"),s("ad0e9324f79a"),n("span",{class:"token operator"},">"),n("span",{class:"token punctuation"},":"),n("span",{class:"token number"},"6"),n("span",{class:"token operator"},">"),s(" wait_for"),n("span",{class:"token operator"},"="),n("span",{class:"token operator"},"<"),s("Future pending cb"),n("span",{class:"token operator"},"="),n("span",{class:"token punctuation"},"["),s("Task"),n("span",{class:"token punctuation"},"."),s("task_wakeup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},">>"),n("span",{class:"token punctuation"},"}"),s(`

In `),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"14"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token builtin"},"type"),n("span",{class:"token punctuation"},"("),s("done"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token builtin"},"type"),n("span",{class:"token punctuation"},"("),s("pending"),n("span",{class:"token punctuation"},")"),s(`
Out`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"14"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token builtin"},"set"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token builtin"},"set"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),N=n("p",null,"看到了吧，这次只有协程 b 完成了，协程 a 还是 pending 状态。",-1),F=n("p",null,[s("在大部分情况下，用 "),n("code",null,"asyncio.gather"),s(" 是足够的，如果你有特殊需求，可以选择 "),n("code",null,"asyncio.wait"),s("，举 2 个例子：")],-1),M=n("ol",null,[n("li",null,"需要拿到封装好的 Task，以便取消或者添加成功回调等"),n("li",null,[s("业务上需要 "),n("code",null,"FIRST_COMPLETED/FIRST_EXCEPTION"),s(" 即返回的")])],-1),z=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` asyncio


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Suspending a'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Resuming a'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'A'"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Suspending b'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Resuming b'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'B'"),s(`


renwu `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),s(`
loops `),n("span",{class:"token operator"},"="),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("get_event_loop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
return_value_a`),n("span",{class:"token punctuation"},","),s(" return_value_b "),n("span",{class:"token operator"},"="),s(" loops"),n("span",{class:"token punctuation"},"."),s("run_until_complete"),n("span",{class:"token punctuation"},"("),s("asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),s("renwu"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token comment"},"# return_value_a, return_value_b = loops.run_until_complete(asyncio.gather(*renwu))"),s(`
`),n("span",{class:"token comment"},"# return_value_a, return_value_b = loops.run_until_complete(asyncio.gather(a(), b()))"),s(`
`),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("return_value_a"),n("span",{class:"token punctuation"},","),s(" return_value_b"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),J=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` asyncio

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Suspending a'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Resuming a'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'A'"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Suspending b'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'Resuming b'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'B'"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"c1"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"c2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"c3"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("wait"),n("span",{class:"token punctuation"},"("),s(`
        `),n("span",{class:"token punctuation"},"["),s("a"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" b"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
        return_when`),n("span",{class:"token operator"},"="),s("asyncio"),n("span",{class:"token punctuation"},"."),s("tasks"),n("span",{class:"token punctuation"},"."),s("FIRST_COMPLETED"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"if"),s(" __name__ "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token string"},"'__main__'"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" f "),n("span",{class:"token keyword"},"in"),s(),n("span",{class:"token punctuation"},"("),s("c1"),n("span",{class:"token punctuation"},","),s(" c2"),n("span",{class:"token punctuation"},","),s(" c3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        asyncio`),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("f"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),D=p(`<h3 id="_2-2-asyncio-create-task-vs-loop-create-task-vs-asyncio-ensure-future" tabindex="-1"><a class="header-anchor" href="#_2-2-asyncio-create-task-vs-loop-create-task-vs-asyncio-ensure-future" aria-hidden="true">#</a> 2.2 asyncio.create_task vs loop.create_task vs asyncio.ensure_future</h3><p>创建一个 Task 一共有 3 种方法，如这小节的标题。从 Python 3.7 开始可以统一的使用更高阶的 <code>asyncio.create_task</code> 。其实<code>asyncio.create_task</code> 就是用的 <code>loop.create_task</code> ：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> asyncio <span class="token keyword">import</span> events


<span class="token keyword">def</span> <span class="token function">create_task</span><span class="token punctuation">(</span>coro<span class="token punctuation">)</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> events<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>loop.create_task</code> 接受的参数需要是一个协程，但是 <code>asyncio.ensure_future</code> 除了接受协程，还可以是 Future 对象或者 awaitable 对象:</p><ol><li>如果参数是协程，其实底层还是用的 <code>loop.create_task</code>，返回 Task 对象</li><li>如果是 Future 对象会直接返回</li><li>如果是一个 awaitable 对象会 await 这个对象的 <code>__await__</code> 方法，再执行一次 <code>ensure_future</code>，最后返回 Task 或者 Future</li></ol><p>所以就像 <code>ensure_future</code> 名字说的，确保这个是一个 Future 对象：Task 是 Future 子类，前面说过一般情况下开发者不需要自己创建 Future</p><p>其实前面说的 <code>asyncio.wait</code> 和 <code>asyncio.gather</code> 里面都用了 <code>asyncio.ensure_future</code> 。对于绝大多数场景要并发执行的是协程，所以直接用 <code>asyncio.create_task</code> 就足够了~</p><h3 id="_2-3-shield" tabindex="-1"><a class="header-anchor" href="#_2-3-shield" aria-hidden="true">#</a> 2.3 shield</h3><p>接着说 <code>asyncio.shield</code>，用它可以屏蔽取消操作。一直到这里，我们还没有见识过 Task 的取消。看一个例子:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>In <span class="token punctuation">:</span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> task1 <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>a<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> task2 <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>b<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> task1<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
Out<span class="token punctuation">:</span> <span class="token boolean">True</span>

In <span class="token punctuation">:</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">)</span>
Suspending a
Suspending b
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
CancelledError                            Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>
cell_name <span class="token keyword">in</span> <span class="token keyword">async</span><span class="token operator">-</span><span class="token keyword">def</span><span class="token operator">-</span>wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>

CancelledError<span class="token punctuation">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的例子中，task1 被取消了后再用 <code>asyncio.gather</code> 收集结果，直接抛 CancelledError 错误了。这里有个细节，gather 支持 <code>return_exceptions</code> 参数：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>In <span class="token punctuation">:</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
Out<span class="token punctuation">:</span> <span class="token punctuation">[</span>concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>_base<span class="token punctuation">.</span>CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，task2 依然会执行完成，但是 task1 的返回值是一个 CancelledError 错误，也就是任务被取消了。如果一个创建后就不希望被任何情况取消，可以使用 <code>asyncio.shield</code> 保护任务能顺利完成：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>In <span class="token punctuation">:</span> task1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>shield<span class="token punctuation">(</span>a<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> task2 <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>b<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> ts <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> task1<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
Out<span class="token punctuation">:</span> <span class="token boolean">True</span>

In <span class="token punctuation">:</span> <span class="token keyword">await</span> ts
Suspending a
Suspending b
Resuming a
Resuming b
Out<span class="token punctuation">:</span> <span class="token punctuation">[</span>concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>_base<span class="token punctuation">.</span>CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到虽然结果是一个 CancelledError 错误，但是看输出能确认协程实际上是执行了的。</p><div class="hint-container info"><p class="hint-container-title">注</p><p>此处之前有一个理解错误，已经在 <a href="#">深入 asyncio.shield</a> 中重新解释和理解，推荐阅读。</p></div><h3 id="_2-4-asynccontextmanager" tabindex="-1"><a class="header-anchor" href="#_2-4-asynccontextmanager" aria-hidden="true">#</a> 2.4 asynccontextmanager</h3><p>如果你了解 Python，之前可能听过或者用过 contextmanager ，一个上下文管理器。通过一个计时的例子就理解它的作用:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&#39;A&#39;</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&#39;B&#39;</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>a<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@contextmanager</span>
<span class="token keyword">def</span> <span class="token function">timed</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;Cost: </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>timed 函数用了 contextmanager 装饰器，把协程的运行结果 yield 出来，执行结束后还计算了耗时：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>In <span class="token punctuation">:</span> <span class="token keyword">from</span> contextmanager <span class="token keyword">import</span> <span class="token operator">*</span>

In <span class="token punctuation">:</span> <span class="token keyword">with</span> timed<span class="token punctuation">(</span>s1<span class="token punctuation">)</span> <span class="token keyword">as</span> rv<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;Result: </span><span class="token interpolation"><span class="token punctuation">{</span>rv<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>
Result<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">]</span>
Cost<span class="token punctuation">:</span> <span class="token number">3.0052654459999992</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>大家先体会一下。在 Python 3.7 添加了 asynccontextmanager，也就是异步版本的 contextmanager，适合异步函数的执行，上例可以这么改：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_timed</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;Cost: </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> async_timed<span class="token punctuation">(</span>s1<span class="token punctuation">)</span> <span class="token keyword">as</span> rv<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;Result: </span><span class="token interpolation"><span class="token punctuation">{</span>rv<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>

In <span class="token punctuation">:</span> asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Result<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">]</span>
Cost<span class="token punctuation">:</span> <span class="token number">3.00414147500004</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>async 版本的 with 要用 <code>async with</code>，另外要注意 <code>yield await func()</code> 这句，相当于 yield +<code>await func()</code></p><p>PS: contextmanager 和 asynccontextmanager 最好的理解方法是去看源码注释，可以看延伸阅读链接 2，另外延伸阅读链接 3 包含的 PR 中相关的测试代码部分也能帮助你理解。</p><h3 id="_2-5-延伸阅读" tabindex="-1"><a class="header-anchor" href="#_2-5-延伸阅读" aria-hidden="true">#</a> 2.5 延伸阅读</h3>`,26),U={href:"https://github.com/python/cpython/blob/3.7/Lib/asyncio/tasks.py#L574",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://github.com/python/cpython/blob/3.7/Lib/contextlib.py#L243",target:"_blank",rel:"noopener noreferrer"},G={href:"https://github.com/python/cpython/pull/360/",target:"_blank",rel:"noopener noreferrer"},X=p(`<h2 id="_3-解密协程运行时" tabindex="-1"><a class="header-anchor" href="#_3-解密协程运行时" aria-hidden="true">#</a> 3. 解密协程运行时</h2><p>说了这么多，现在，我们不妨来深入代码底层看看。有了前面的知识做基础，你应该很容易理解这两段代码。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_1 start&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_1 done&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_2 start&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_2 done&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;before await&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> worker_1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;awaited worker_1&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> worker_2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;awaited worker_2&#39;</span><span class="token punctuation">)</span>

<span class="token operator">%</span>time asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">########## 输出 ##########</span>

before <span class="token keyword">await</span>
worker_1 start
worker_1 done
awaited worker_1
worker_2 start
worker_2 done
awaited worker_2
Wall time<span class="token punctuation">:</span> <span class="token number">3</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_1 start&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_1 done&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_2 start&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;worker_2 done&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>worker_1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>worker_2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;before await&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> task1
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;awaited worker_1&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> task2
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;awaited worker_2&#39;</span><span class="token punctuation">)</span>

<span class="token operator">%</span>time asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">########## 输出 ##########</span>

before <span class="token keyword">await</span>
worker_1 start
worker_2 start
worker_1 done
awaited worker_1
worker_2 done
awaited worker_2
Wall time<span class="token punctuation">:</span> <span class="token number">2.01</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过，第二个代码，到底发生了什么呢？为了让你更详细了解到协程和线程的具体区别，这里我详细地分析了整个过程。步骤有点多，别着急，我们慢慢来看。</p><ol><li><code>asyncio.run(main())</code>，程序进入 <code>main()</code> 函数，事件循环开启；</li><li>task1 和 task2 任务被创建，并进入事件循环等待运行；运行到 print，输出 <code>&#39;before await&#39;</code>；</li><li>await task1 执行，用户选择从当前的主任务中切出，事件调度器开始调度 <code>worker_1</code>；</li><li><code>worker_1</code> 开始运行，运行 print 输出 <code>&#39;worker_1 start&#39;</code>，然后运行到 <code>await asyncio.sleep(1)</code>， 从当前任务切出，事件调度器开始调度 <code>worker_2</code>；</li><li><code>worker_2</code> 开始运行，运行 print 输出 <code>&#39;worker_2 start&#39;</code>，然后运行 <code>await asyncio.sleep(2)</code> 从当前任务切出；</li><li>以上所有事件的运行时间，都应该在 1ms 到 10ms 之间，甚至可能更短，事件调度器从这个时候开始暂停调度；</li><li>一秒钟后，<code>worker_1</code> 的 sleep 完成，事件调度器将控制权重新传给 <code>task_1</code>，输出 <code>&#39;worker_1 done&#39;</code>，<code>task_1</code> 完成任务，从事件循环中退出；</li><li><code>await task1</code> 完成，事件调度器将控制器传给主任务，输出 <code>&#39;awaited worker_1&#39;</code>，·然后在 <code>await task2</code> 处继续等待；</li><li>两秒钟后，<code>worker_2</code> 的 sleep 完成，事件调度器将控制权重新传给 <code>task_2</code>，输出 <code>&#39;worker_2 done&#39;</code>，<code>task_2</code> 完成任务，从事件循环中退出；</li><li>主任务输出 <code>&#39;awaited worker_2&#39;</code>，协程全任务结束，事件循环结束。</li></ol><p>接下来，我们进阶一下。如果我们想给某些协程任务限定运行时间，一旦超时就取消，又该怎么做呢？再进一步，如果某些协程运行时出现错误，又该怎么处理呢？同样的，来看代码。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">0</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">worker_3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">3</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task_1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>worker_1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>worker_2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_3 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>worker_3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    task_3<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    res <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>task_1<span class="token punctuation">,</span> task_2<span class="token punctuation">,</span> task_3<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

<span class="token operator">%</span>time asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">########## 输出 ##########</span>

<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> ZeroDivisionError<span class="token punctuation">(</span><span class="token string">&#39;division by zero&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
Wall time<span class="token punctuation">:</span> <span class="token number">2</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以看到，<code>worker_1</code> 正常运行，<code>worker_2</code> 运行中出现错误，<code>worker_3</code> 执行时间过长被我们 cancel 掉了，这些信息会全部体现在最终的返回结果 res 中。</p><p>不过要注意 <code>return_exceptions=True</code> 这行代码。如果不设置这个参数，错误就会完整地 throw 到我们这个执行层，从而需要 <code>try except</code> 来捕捉，这也就意味着其他还没被执行的任务会被全部取消掉。为了避免这个局面，我们将 <code>return_exceptions</code> 设置为 True 即可。</p><p>到这里，发现了没，线程能实现的，协程都能做到。那就让我们温习一下这些知识点，用协程来实现一个经典的生产者消费者模型吧。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> random

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        val <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;{} get a val: {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">producer</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;{} put a val: {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    queue <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>

    consumer_1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>consumer<span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token string">&#39;consumer_1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    consumer_2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>consumer<span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token string">&#39;consumer_2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    producer_1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>producer<span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token string">&#39;producer_1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    producer_2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>producer<span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token string">&#39;producer_2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    consumer_1<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    consumer_2<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>consumer_1<span class="token punctuation">,</span> consumer_2<span class="token punctuation">,</span> producer_1<span class="token punctuation">,</span> producer_2<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token operator">%</span>time asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">########## 输出 ##########</span>

producer_1 put a val<span class="token punctuation">:</span> <span class="token number">5</span>
producer_2 put a val<span class="token punctuation">:</span> <span class="token number">3</span>
consumer_1 get a val<span class="token punctuation">:</span> <span class="token number">5</span>
consumer_2 get a val<span class="token punctuation">:</span> <span class="token number">3</span>
producer_1 put a val<span class="token punctuation">:</span> <span class="token number">1</span>
producer_2 put a val<span class="token punctuation">:</span> <span class="token number">3</span>
consumer_2 get a val<span class="token punctuation">:</span> <span class="token number">1</span>
consumer_1 get a val<span class="token punctuation">:</span> <span class="token number">3</span>
producer_1 put a val<span class="token punctuation">:</span> <span class="token number">6</span>
producer_2 put a val<span class="token punctuation">:</span> <span class="token number">10</span>
consumer_1 get a val<span class="token punctuation">:</span> <span class="token number">6</span>
consumer_2 get a val<span class="token punctuation">:</span> <span class="token number">10</span>
producer_1 put a val<span class="token punctuation">:</span> <span class="token number">4</span>
producer_2 put a val<span class="token punctuation">:</span> <span class="token number">5</span>
consumer_2 get a val<span class="token punctuation">:</span> <span class="token number">4</span>
consumer_1 get a val<span class="token punctuation">:</span> <span class="token number">5</span>
producer_1 put a val<span class="token punctuation">:</span> <span class="token number">2</span>
producer_2 put a val<span class="token punctuation">:</span> <span class="token number">8</span>
consumer_1 get a val<span class="token punctuation">:</span> <span class="token number">2</span>
consumer_2 get a val<span class="token punctuation">:</span> <span class="token number">8</span>
Wall time<span class="token punctuation">:</span> <span class="token number">10</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-实战-豆瓣近日推荐电影爬虫" tabindex="-1"><a class="header-anchor" href="#_4-实战-豆瓣近日推荐电影爬虫" aria-hidden="true">#</a> 4. 实战：豆瓣近日推荐电影爬虫</h2><p>最后，进入今天的实战环节——实现一个完整的协程爬虫。</p>`,14),H={href:"https://movie.douban.com/cinema/later/beijing/",target:"_blank",rel:"noopener noreferrer"},V=n("p",null,"听起来难度不是很大吧？我在下面给出了同步版本的代码和协程版本的代码，通过运行时间和代码写法的对比，希望你能对协程有更深的了解。（注意：为了突出重点、简化代码，这里我省略了异常处理。）",-1),Z=n("p",null,"不过，在参考我给出的代码之前，你是不是可以自己先动手写一下、跑一下呢？",-1),$=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` requests
`),n("span",{class:"token keyword"},"from"),s(" bs4 "),n("span",{class:"token keyword"},"import"),s(` BeautifulSoup


`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    headers `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token string"},'"User-Agent"'),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token string"},'"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"'),n("span",{class:"token punctuation"},","),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    url `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"https://movie.douban.com/cinema/later/beijing/"'),s(`
    init_page `),n("span",{class:"token operator"},"="),s(" requests"),n("span",{class:"token punctuation"},"."),s("get"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},","),s(" headers"),n("span",{class:"token operator"},"="),s("headers"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s(`content
    `),n("span",{class:"token comment"},"# print(init_page)"),s(`
    init_soup `),n("span",{class:"token operator"},"="),s(" BeautifulSoup"),n("span",{class:"token punctuation"},"("),s("init_page"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'lxml'"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token comment"},"# print(init_soup)"),s(`
    all_movies `),n("span",{class:"token operator"},"="),s(" init_soup"),n("span",{class:"token punctuation"},"."),s("find"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'div'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token builtin"},"id"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"showing-soon"'),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token comment"},"# print(all_movies)"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" each_movie "),n("span",{class:"token keyword"},"in"),s(" all_movies"),n("span",{class:"token punctuation"},"."),s("find_all"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'div'"),n("span",{class:"token punctuation"},","),s(" class_"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"item"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token comment"},"# print(each_movie)"),s(`
        all_a_tag `),n("span",{class:"token operator"},"="),s(" each_movie"),n("span",{class:"token punctuation"},"."),s("find_all"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'a'"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token comment"},"# print(all_a_tag)"),s(`
        all_li_tag `),n("span",{class:"token operator"},"="),s(" each_movie"),n("span",{class:"token punctuation"},"."),s("find_all"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'li'"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token comment"},"# print(all_li_tag)"),s(`
        movie_name `),n("span",{class:"token operator"},"="),s(" all_a_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s(`text
        `),n("span",{class:"token comment"},"# print(movie_name)"),s(`
        url_to_fetch `),n("span",{class:"token operator"},"="),s(" all_a_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'href'"),n("span",{class:"token punctuation"},"]"),s(`
        `),n("span",{class:"token comment"},"# print(url_to_fetch)"),s(`
        movie_date `),n("span",{class:"token operator"},"="),s(" all_li_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s(`text
        `),n("span",{class:"token comment"},"# print(movie_date)"),s(`
        response_item `),n("span",{class:"token operator"},"="),s(" requests"),n("span",{class:"token punctuation"},"."),s("get"),n("span",{class:"token punctuation"},"("),s("url_to_fetch"),n("span",{class:"token punctuation"},","),s(" headers"),n("span",{class:"token operator"},"="),s("headers"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s(`content
        `),n("span",{class:"token comment"},"# print(response_item)"),s(`
        soup_item `),n("span",{class:"token operator"},"="),s(" BeautifulSoup"),n("span",{class:"token punctuation"},"("),s("response_item"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'lxml'"),n("span",{class:"token punctuation"},")"),s(`
        img_tag `),n("span",{class:"token operator"},"="),s(" soup_item"),n("span",{class:"token punctuation"},"."),s("find"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'img'"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token comment"},"# print(img_tag)"),s(`
        `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'{} {} {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("movie_name"),n("span",{class:"token punctuation"},","),s(" movie_date"),n("span",{class:"token punctuation"},","),s(" img_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'src'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token operator"},"%"),s("time main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),Y=n("details",{class:"hint-container details"},[n("summary",null,"输出"),n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[s("风再起时 "),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"05"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img9"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2887039584"),n("span",{class:"token punctuation"},"."),s(`jpg
黑豹`),n("span",{class:"token number"},"2"),s(),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"07"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img9"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886589774"),n("span",{class:"token punctuation"},"."),s(`jpg
不能流泪的悲伤 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"14"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886531289"),n("span",{class:"token punctuation"},"."),s(`jpg
蚁人与黄蜂女：量子狂潮 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"17"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886589789"),n("span",{class:"token punctuation"},"."),s(`jpg
中国乒乓之绝地反击 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"17"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img9"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2887100255"),n("span",{class:"token punctuation"},"."),s(`jpg
印式英语 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"24"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886633470"),n("span",{class:"token punctuation"},"."),s(`jpg
毒舌律师 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"24"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img9"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886619074"),n("span",{class:"token punctuation"},"."),s(`jpg
会考试的猛犸象 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"24"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img9"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2879572685"),n("span",{class:"token punctuation"},"."),s(`jpg
拨浪鼓咚咚响 `),n("span",{class:"token number"},"02"),s("月"),n("span",{class:"token number"},"25"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img2"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886538033"),n("span",{class:"token punctuation"},"."),s(`jpg
宇宙探索编辑部 `),n("span",{class:"token number"},"04"),s("月"),n("span",{class:"token number"},"01"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886529968"),n("span",{class:"token punctuation"},"."),s(`jpg
龙马精神 `),n("span",{class:"token number"},"04"),s("月"),n("span",{class:"token number"},"07"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img2"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2887204283"),n("span",{class:"token punctuation"},"."),s(`jpg
长空之王 `),n("span",{class:"token number"},"04"),s("月"),n("span",{class:"token number"},"28"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img9"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886235064"),n("span",{class:"token punctuation"},"."),s(`jpg
人生路不熟 `),n("span",{class:"token number"},"04"),s("月"),n("span",{class:"token number"},"28"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2887091779"),n("span",{class:"token punctuation"},"."),s(`jpg
检察风云 `),n("span",{class:"token number"},"04"),s("月"),n("span",{class:"token number"},"29"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886533208"),n("span",{class:"token punctuation"},"."),s(`jpg
请别相信她 `),n("span",{class:"token number"},"05"),s("月"),n("span",{class:"token number"},"20"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886540928"),n("span",{class:"token punctuation"},"."),s(`jpg
伟大的胜利 `),n("span",{class:"token number"},"09"),s("月"),n("span",{class:"token number"},"30"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img1"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2886621940"),n("span",{class:"token punctuation"},"."),s(`jpg
CPU times`),n("span",{class:"token punctuation"},":"),s(" user "),n("span",{class:"token number"},"564"),s(" ms"),n("span",{class:"token punctuation"},","),s(" sys"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"29.9"),s(" ms"),n("span",{class:"token punctuation"},","),s(" total"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"594"),s(` ms
Wall time`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"19.7"),s(` s
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])])],-1),nn=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` asyncio
`),n("span",{class:"token keyword"},"import"),s(` aiohttp

`),n("span",{class:"token keyword"},"from"),s(" bs4 "),n("span",{class:"token keyword"},"import"),s(` BeautifulSoup

header `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token string"},'"User-Agent"'),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token string"},'"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"'),n("span",{class:"token punctuation"},","),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"fetch_content"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"with"),s(" aiohttp"),n("span",{class:"token punctuation"},"."),s("ClientSession"),n("span",{class:"token punctuation"},"("),s(`
        headers`),n("span",{class:"token operator"},"="),s("header"),n("span",{class:"token punctuation"},","),s(" connector"),n("span",{class:"token operator"},"="),s("aiohttp"),n("span",{class:"token punctuation"},"."),s("TCPConnector"),n("span",{class:"token punctuation"},"("),s("ssl"),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"False"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"as"),s(" session"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"with"),s(" session"),n("span",{class:"token punctuation"},"."),s("get"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"as"),s(" response"),n("span",{class:"token punctuation"},":"),s(`
            `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token keyword"},"await"),s(" response"),n("span",{class:"token punctuation"},"."),s("text"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    url `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"https://movie.douban.com/cinema/later/beijing/"'),s(`
    init_page `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" fetch_content"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),s(`
    init_soup `),n("span",{class:"token operator"},"="),s(" BeautifulSoup"),n("span",{class:"token punctuation"},"("),s("init_page"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'lxml'"),n("span",{class:"token punctuation"},")"),s(`

    movie_names`),n("span",{class:"token punctuation"},","),s(" urls_to_fetch"),n("span",{class:"token punctuation"},","),s(" movie_dates "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(`

    all_movies `),n("span",{class:"token operator"},"="),s(" init_soup"),n("span",{class:"token punctuation"},"."),s("find"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'div'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token builtin"},"id"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"showing-soon"'),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" each_movie "),n("span",{class:"token keyword"},"in"),s(" all_movies"),n("span",{class:"token punctuation"},"."),s("find_all"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'div'"),n("span",{class:"token punctuation"},","),s(" class_"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"item"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        all_a_tag `),n("span",{class:"token operator"},"="),s(" each_movie"),n("span",{class:"token punctuation"},"."),s("find_all"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'a'"),n("span",{class:"token punctuation"},")"),s(`
        all_li_tag `),n("span",{class:"token operator"},"="),s(" each_movie"),n("span",{class:"token punctuation"},"."),s("find_all"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'li'"),n("span",{class:"token punctuation"},")"),s(`

        movie_names`),n("span",{class:"token punctuation"},"."),s("append"),n("span",{class:"token punctuation"},"("),s("all_a_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("text"),n("span",{class:"token punctuation"},")"),s(`
        urls_to_fetch`),n("span",{class:"token punctuation"},"."),s("append"),n("span",{class:"token punctuation"},"("),s("all_a_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'href'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
        movie_dates`),n("span",{class:"token punctuation"},"."),s("append"),n("span",{class:"token punctuation"},"("),s("all_li_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("text"),n("span",{class:"token punctuation"},")"),s(`

    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("fetch_content"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls_to_fetch"),n("span",{class:"token punctuation"},"]"),s(`
    pages `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tasks"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"for"),s(" movie_name"),n("span",{class:"token punctuation"},","),s(" movie_date"),n("span",{class:"token punctuation"},","),s(" page "),n("span",{class:"token keyword"},"in"),s(),n("span",{class:"token builtin"},"zip"),n("span",{class:"token punctuation"},"("),s("movie_names"),n("span",{class:"token punctuation"},","),s(" movie_dates"),n("span",{class:"token punctuation"},","),s(" pages"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        soup_item `),n("span",{class:"token operator"},"="),s(" BeautifulSoup"),n("span",{class:"token punctuation"},"("),s("page"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'lxml'"),n("span",{class:"token punctuation"},")"),s(`
        img_tag `),n("span",{class:"token operator"},"="),s(" soup_item"),n("span",{class:"token punctuation"},"."),s("find"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'img'"),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'{} {} {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("movie_name"),n("span",{class:"token punctuation"},","),s(" movie_date"),n("span",{class:"token punctuation"},","),s(" img_tag"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'src'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"# %time asyncio.run(main())"),s(`

`),n("span",{class:"token keyword"},"if"),s(" __name__ "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token string"},"'__main__'"),n("span",{class:"token punctuation"},":"),s(`
    start_time `),n("span",{class:"token operator"},"="),s(" time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
    loops `),n("span",{class:"token operator"},"="),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("get_event_loop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
    loops`),n("span",{class:"token punctuation"},"."),s("run_until_complete"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" start_time"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"########## 输出 ##########"),s(`

阿拉丁 `),n("span",{class:"token number"},"05"),s("月"),n("span",{class:"token number"},"24"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img3"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2553992741"),n("span",{class:"token punctuation"},"."),s(`jpg
龙珠超：布罗利 `),n("span",{class:"token number"},"05"),s("月"),n("span",{class:"token number"},"24"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img3"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2557371503"),n("span",{class:"token punctuation"},"."),s(`jpg
五月天人生无限公司 `),n("span",{class:"token number"},"05"),s("月"),n("span",{class:"token number"},"24"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img3"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2554324453"),n("span",{class:"token punctuation"},"."),s(`jpg
`),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),s(),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),s(`
直播攻略 `),n("span",{class:"token number"},"06"),s("月"),n("span",{class:"token number"},"04"),s("日 https"),n("span",{class:"token punctuation"},":"),n("span",{class:"token operator"},"//"),s("img3"),n("span",{class:"token punctuation"},"."),s("doubanio"),n("span",{class:"token punctuation"},"."),s("com"),n("span",{class:"token operator"},"/"),s("view"),n("span",{class:"token operator"},"/"),s("photo"),n("span",{class:"token operator"},"/"),s("s_ratio_poster"),n("span",{class:"token operator"},"/"),s("public"),n("span",{class:"token operator"},"/"),s("p2555957974"),n("span",{class:"token punctuation"},"."),s(`jpg
Wall time`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"4.98"),s(` s
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),sn=p('<h2 id="_5-总结" tabindex="-1"><a class="header-anchor" href="#_5-总结" aria-hidden="true">#</a> 5. 总结</h2><p>到这里，今天的主要内容就讲完了。今天我用了较长的篇幅，从一个简单的爬虫开始，到一个真正的爬虫结束，在中间穿插讲解了 Python 协程最新的基本概念和用法。这里带你简单复习一下。</p><ul><li>协程和多线程的区别，主要在于两点，一是协程为单线程；二是协程由用户决定，在哪些地方交出控制权，切换到下一个任务。</li><li>协程的写法更加简洁清晰，把 async / await 语法和 <code>create_task</code> 结合来用，对于中小级别的并发需求已经毫无压力。</li><li>写协程程序的时候，你的脑海中要有清晰的事件循环概念，知道程序在什么时候需要暂停、等待 I/O，什么时候需要一并执行到底。</li></ul><p>最后的最后，请一定不要轻易炫技。多线程模型也一定有其优点，一个真正牛逼的程序员，应该懂得，在什么时候用什么模型能达到工程上的最优，而不是自觉某个技术非常牛逼，所有项目创造条件也要上。技术是工程，而工程则是时间、资源、人力等纷繁复杂的事情的折衷。</p><h2 id="_6-思考题" tabindex="-1"><a class="header-anchor" href="#_6-思考题" aria-hidden="true">#</a> 6. 思考题</h2><p>最后给你留一个思考题。协程怎么实现回调函数呢？欢迎留言和我讨论，也欢迎你把这篇文章分享给你的同事朋友，我们一起交流，一起进步。</p><h2 id="_7-评论" tabindex="-1"><a class="header-anchor" href="#_7-评论" aria-hidden="true">#</a> 7. 评论</h2><h3 id="_7-1-讲师" tabindex="-1"><a class="header-anchor" href="#_7-1-讲师" aria-hidden="true">#</a> 7.1 讲师</h3><p>发现评论区好多朋友说无法运行，在这里统一解释下：</p><ol><li><code>%time</code> 是 jupyter notebook 自带的语法糖，用来统计一行命令的运行时间；如果你的运行时是纯粹的命令行 python，或者 pycharm，那么请把 <code>%time</code> 删掉，自己用传统的时间戳方法来记录时间也可以；或者使用 jupyter notebook</li><li>我的本地解释器是 Anaconda Python 3.7.3，亲测 windows / ubuntu 均可正常运行，如无法执行可以试试 <code>pip install nest-asyncio</code>，依然无法解决请尝试安装 Anaconda Python</li><li>这次代码因为使用了较新的 API，所以需要较新的版本号，但是朋友们依然出现了一些运行时问题，这里先表示下歉意；同时也想说明的是，在提问之前自己经过充分搜索，尝试后解决问题，带来的快感，和能力的提升，相应也是很大的，一门工程最需要的是 hands on dirty work（动手做脏活），才能让自己的能力得到本质的提升，加油！</li></ol><hr><h3 id="_7-2-讲师" tabindex="-1"><a class="header-anchor" href="#_7-2-讲师" aria-hidden="true">#</a> 7.2 讲师</h3><p><strong>思考题答案：</strong></p><p>在 Python 3.7 及以上的版本中，我们对 task 对象调用 <code>add_done_callback() </code>函数，即可绑定特定回调函数。回调函数接受一个 future 对象，可以通过 <code>future.result()</code> 来获取协程函数的返回值。</p><p><strong>示例如下：</strong></p>',15),an=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(` asyncio

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'crawling {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'_'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'OK {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" task "),n("span",{class:"token keyword"},"in"),s(" tasks"),n("span",{class:"token punctuation"},":"),s(`
        task`),n("span",{class:"token punctuation"},"."),s("add_done_callback"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"lambda"),s(" future"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'result: '"),n("span",{class:"token punctuation"},","),s(" future"),n("span",{class:"token punctuation"},"."),s("result"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tasks"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token operator"},"%"),s("time asyncio"),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"# 输出："),s(`

crawling url_1
crawling url_2
crawling url_3
crawling url_4
result`),n("span",{class:"token punctuation"},":"),s(`  OK url_1
result`),n("span",{class:"token punctuation"},":"),s(`  OK url_2
result`),n("span",{class:"token punctuation"},":"),s(`  OK url_3
result`),n("span",{class:"token punctuation"},":"),s(`  OK url_4
Wall time`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"4"),s(` s
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),tn=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{python:"",class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(" asyncio"),n("span",{class:"token punctuation"},","),s(` time

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'crawling {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'_'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'OK {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" task "),n("span",{class:"token keyword"},"in"),s(" tasks"),n("span",{class:"token punctuation"},":"),s(`
        task`),n("span",{class:"token punctuation"},"."),s("add_done_callback"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"lambda"),s(" future"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'result: '"),n("span",{class:"token punctuation"},","),s(" future"),n("span",{class:"token punctuation"},"."),s("result"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tasks"),n("span",{class:"token punctuation"},")"),s(`

start_time `),n("span",{class:"token operator"},"="),s(" time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"await"),s(" main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" start_time"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," ")]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),en=n("div",{class:"language-python line-numbers-mode","data-ext":"py"},[n("pre",{python:"",class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(" asyncio"),n("span",{class:"token punctuation"},","),s(` time


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'crawling {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    sleep_time `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"int"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},"."),s("split"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'_'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("sleep"),n("span",{class:"token punctuation"},"("),s("sleep_time"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},"'OK {}'"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"format"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),s("urls"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    tasks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"["),s("asyncio"),n("span",{class:"token punctuation"},"."),s("create_task"),n("span",{class:"token punctuation"},"("),s("crawl_page"),n("span",{class:"token punctuation"},"("),s("url"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"for"),s(" url "),n("span",{class:"token keyword"},"in"),s(" urls"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" task "),n("span",{class:"token keyword"},"in"),s(" tasks"),n("span",{class:"token punctuation"},":"),s(`
        task`),n("span",{class:"token punctuation"},"."),s("add_done_callback"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"lambda"),s(" future"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},"'result: '"),n("span",{class:"token punctuation"},","),s(" future"),n("span",{class:"token punctuation"},"."),s("result"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"await"),s(" asyncio"),n("span",{class:"token punctuation"},"."),s("gather"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tasks"),n("span",{class:"token punctuation"},")"),s(`


start_time `),n("span",{class:"token operator"},"="),s(" time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
asyncio`),n("span",{class:"token punctuation"},"."),s("run"),n("span",{class:"token punctuation"},"("),s("main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'url_1'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_2'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_3'"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},"'url_4'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),s("time"),n("span",{class:"token punctuation"},"."),s("time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" start_time"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("div",{class:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," "),n("div",{class:"highlight-line"}," ")]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),on=p(`<hr><h3 id="_7-3-helloworld" tabindex="-1"><a class="header-anchor" href="#_7-3-helloworld" aria-hidden="true">#</a> 7.3 helloworld</h3><p>说一下我对 await 的理解： 开发者要提前知道一个任务的哪个环节会造成 I/O 阻塞，然后把这个环节的代码异步化处理，并且通过 await来标识在任务的该环节中断该任务执行，从而去执行下一个事件循环任务。这样可以充分利用 CPU 资源，避免 CPU 等待 I/O 造成 CPU 资源白白浪费。当之前任务的那个环节的 I/O 完成后，线程可以从 await 获取返回值，然后继续执行没有完成的剩余代码。 由上面分析可知，如果一个任务不涉及到网络或磁盘 I/O 这种耗时的操作，而只有 CPU 计算和内存 I/O 的操作时，协程并发的性能还不如单线程 loop 循环的性能高。</p><hr><h3 id="_7-4-大侠110" tabindex="-1"><a class="header-anchor" href="#_7-4-大侠110" aria-hidden="true">#</a> 7.4 大侠110</h3><p>感觉还是有很多人看不懂，我试着用通俗的语句讲一下：协成里面重要的是一个关键字 await 的理解，async 表示其修饰的是协程任务即 task，await 表示的是当线程执行到这一句，此时该 task 在此处挂起，然后调度器去执行其他的 task，当这个挂起的部分处理完，会调用回掉函数告诉调度器我已经执行完了，那么调度器就返回来处理这个 task 的余下语句。</p><hr><h3 id="_7-5-airnm-毁" tabindex="-1"><a class="header-anchor" href="#_7-5-airnm-毁" aria-hidden="true">#</a> 7.5 Airnm.毁</h3><p>豆瓣那个发现 <code>requests.get(url).content/text</code> 返回都为空，然后打了下 status_code 发现是 418，网上找 418 的解释，一般是网站反爬虫基础机制，需要加请求头模仿浏览器就可跳过，改为下面的样子就可通过：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>url <span class="token operator">=</span> <span class="token string">&quot;https://movie.douban.com/cinema/later/beijing/&quot;</span> 
head<span class="token operator">=</span><span class="token punctuation">{</span>    <span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)Chrome/81.0.4044.113 Safari/537.36&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;Referer&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;https://time.geekbang.org/column/article/101855&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;Connection&#39;</span><span class="token punctuation">:</span><span class="token string">&#39;keep-alive&#39;</span><span class="token punctuation">}</span> 
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>head<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>作者回复: 👍，可能是增加了反爬虫机制</p></blockquote><hr><h3 id="_7-7-长期规划" tabindex="-1"><a class="header-anchor" href="#_7-7-长期规划" aria-hidden="true">#</a> 7.7 长期规划</h3><p>老师，在最后那个协程例子中为何没用 requests 库呢？是因为它不支持协程吗</p><blockquote><p>作者回复: 协程使用的是 aiohttp 并发网络 io 库，因此就不需要 requests 了</p></blockquote><h2 id="_8-报错处理" tabindex="-1"><a class="header-anchor" href="#_8-报错处理" aria-hidden="true">#</a> 8. 报错处理</h2><h3 id="_8-1-runtimeerror-asyncio-run-cannot-be-called-from-a-running-event-loop" tabindex="-1"><a class="header-anchor" href="#_8-1-runtimeerror-asyncio-run-cannot-be-called-from-a-running-event-loop" aria-hidden="true">#</a> 8.1 RuntimeError: asyncio.run() cannot be called from a running event loop</h3><p>学习协程异步操作出现的问题：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func_4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;营养快线&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># time.sleep(3) </span>
    <span class="token comment"># print(&quot;娃哈哈&quot;)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    g <span class="token operator">=</span> func_4<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 此时的函数是异步协程函数，此时函数执行得到一个协程对象</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>g<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码报错：</p><p><code>RuntimeError: asyncio.run() cannot be called from a running event loop</code></p><p>意思大致就是 jupyter 已经运行了 loop，无需自己激活，修改为：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func_4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;营养快线&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># time.sleep(3) </span>
    <span class="token comment"># print(&quot;娃哈哈&quot;)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    g <span class="token operator">=</span> func_4<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 此时的函数是异步协程函数，此时函数执行得到一个协程对象</span>
    <span class="token comment">#asyncio.run(g)</span>
    <span class="token keyword">await</span> g
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-syntaxerror-await-outside-async-function的原因与解决" tabindex="-1"><a class="header-anchor" href="#_8-2-syntaxerror-await-outside-async-function的原因与解决" aria-hidden="true">#</a> 8.2 SyntaxError: ‘await‘ outside async function的原因与解决</h3><p>我们看下面这个代码，表面上没什么问题：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;两秒过去了&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;两秒又过去了&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;四秒过去了&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">await</span> do1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> do2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> do3<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但运行了以后会这样报错：</p><figure><img src="`+_+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>原因：</strong> await 是要和创建协程时 async 一起搭配使用的，直接使用 await 就会找不到他所在的函数的，于是报错在函数外。</p><p>解决方法：</p><ul><li>创建任务单</li><li>创建事件</li><li>实现并发运行</li></ul><p>改进代码：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;两秒过去了&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;三秒过去了&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;四秒过去了&#39;</span><span class="token punctuation">)</span>


renwu <span class="token operator">=</span> <span class="token punctuation">[</span>do1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> do2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> do3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
loops <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loops<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>renwu<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+g+'" alt="image-20230130101219537" tabindex="0" loading="lazy"><figcaption>image-20230130101219537</figcaption></figure><p>完成的很顺利。</p><p>欢迎关注我公众号：AI悦创，有更多更好玩的等你发现！</p><details class="hint-container details"><summary>公众号：AI悦创【二维码】</summary><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></details>',37),pn={class:"hint-container info"},cn=n("p",{class:"hint-container-title"},"AI悦创·编程一对一",-1),ln=n("p",null,"AI悦创·推出辅导班啦，包括「Python 语言辅导班、C++ 辅导班、java 辅导班、算法/数据结构辅导班、少儿编程、pygame 游戏开发」，全部都是一对一教学：一对一辅导 + 一对一答疑 + 布置作业 + 项目实践等。当然，还有线下线上摄影课程、Photoshop、Premiere 一对一教学、QQ、微信在线，随时响应！微信：Jiabcdefh",-1),un=n("p",null,"C++ 信息奥赛题解，长期更新！长期招收一对一中小学信息奥赛集训，莆田、厦门地区有机会线下上门，其他地区线上。微信：Jiabcdefh",-1),rn={href:"http://wpa.qq.com/msgrd?v=3&uin=1432803776&site=qq&menu=yes",target:"_blank",rel:"noopener noreferrer"},kn=n("p",null,"方法二：微信：Jiabcdefh",-1),dn=n("figure",null,[n("img",{src:k,alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1);function mn(vn,bn){const l=i("CodeTabs"),u=i("Tabs"),c=i("ExternalLinkIcon");return m(),v("div",null,[h,o(l,{id:"92",data:[{id:"old"},{id:"Run in Jupyter Notebook"},{id:"Python file"}],"tab-id":"python"},{title0:a(({value:t,isActive:e})=>[s("old")]),title1:a(({value:t,isActive:e})=>[s("Run in Jupyter Notebook")]),title2:a(({value:t,isActive:e})=>[s("Python file")]),tab0:a(({value:t,isActive:e})=>[f]),tab1:a(({value:t,isActive:e})=>[x]),tab2:a(({value:t,isActive:e})=>[O]),_:1}),T,o(l,{id:"237",data:[{id:"old"},{id:"Pycharm"}],"tab-id":"python"},{title0:a(({value:t,isActive:e})=>[s("old")]),title1:a(({value:t,isActive:e})=>[s("Pycharm")]),tab0:a(({value:t,isActive:e})=>[I]),tab1:a(({value:t,isActive:e})=>[P]),_:1}),A,o(u,{id:"264",data:[{id:"Ipython"},{id:"Pycharm"},{id:"coro1.py"}]},{title0:a(({value:t,isActive:e})=>[s("Ipython")]),title1:a(({value:t,isActive:e})=>[s("Pycharm")]),title2:a(({value:t,isActive:e})=>[s("coro1.py")]),tab0:a(({value:t,isActive:e})=>[K,S,C,q,j,R,E,B,L,W,N,F,M]),tab1:a(({value:t,isActive:e})=>[z]),tab2:a(({value:t,isActive:e})=>[J]),_:1},8,["data"]),D,n("ol",null,[n("li",null,[n("a",U,[s("https://github.com/python/cpython/blob/3.7/Lib/asyncio/tasks.py#L574"),o(c)])]),n("li",null,[n("a",Q,[s("https://github.com/python/cpython/blob/3.7/Lib/contextlib.py#L243"),o(c)])]),n("li",null,[n("a",G,[s("https://github.com/python/cpython/pull/360/"),o(c)])])]),X,n("p",null,[s("任务描述："),n("a",H,[s("https://movie.douban.com/cinema/later/beijing/"),o(c)]),s(" 这个页面描述了北京最近上映的电影，你能否通过 Python 得到这些电影的名称、上映时间和海报呢？这个页面的海报是缩小版的，我希望你能从具体的电影描述页面中抓取到海报。")]),V,Z,o(u,{id:"514",data:[{id:"正常版本"},{id:"协程版本"}]},{title0:a(({value:t,isActive:e})=>[s("正常版本")]),title1:a(({value:t,isActive:e})=>[s("协程版本")]),tab0:a(({value:t,isActive:e})=>[$,Y]),tab1:a(({value:t,isActive:e})=>[nn]),_:1}),sn,o(l,{id:"596",data:[{id:"old"},{id:"Run on Jupyter Notebook"},{id:"Run on Pycharm"}],"tab-id":"python"},{title0:a(({value:t,isActive:e})=>[s("old")]),title1:a(({value:t,isActive:e})=>[s("Run on Jupyter Notebook")]),title2:a(({value:t,isActive:e})=>[s("Run on Pycharm")]),tab0:a(({value:t,isActive:e})=>[an]),tab1:a(({value:t,isActive:e})=>[tn]),tab2:a(({value:t,isActive:e})=>[en]),_:1}),on,n("div",pn,[cn,ln,un,n("p",null,[s("方法一："),n("a",rn,[s("QQ"),o(c)])]),kn]),dn])}const hn=d(w,[["render",mn],["__file","20.html.vue"]]);export{hn as default};
